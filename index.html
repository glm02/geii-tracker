<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My GEII Tracker AI - Rafael Guilland-Mille</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel pour le JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configuration Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        geii: {
                            dark: '#0f172a',
                            card: '#1e293b',
                            accent: '#3b82f6',
                            success: '#10b981',
                            warning: '#f59e0b',
                            danger: '#ef4444'
                        }
                    },
                    animation: {
                        'gradient': 'gradient 3s ease infinite',
                    },
                    keyframes: {
                        gradient: {
                            '0%, 100%': { 'background-size': '200% 200%', 'background-position': 'left center' },
                            '50%': { 'background-size': '200% 200%', 'background-position': 'right center' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Masquer les flèches des input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .ai-gradient-text {
            background: linear-gradient(to right, #60a5fa, #c084fc, #f472b6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .ai-border {
            position: relative;
        }
        .ai-border::before {
            content: "";
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            padding: 2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899);
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- CONFIGURATION GEMINI API ---
        const apiKey = ""; // La clé est injectée automatiquement par l'environnement
        
        const callGemini = async (prompt, systemInstruction = "") => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            // Backoff logic
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i < delays.length; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Pas de réponse.";
                } catch (error) {
                    if (i === delays.length - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        };

        // --- DONNÉES ET CONFIGURATION ---
        
        const MODULES_CONFIG = [
            { id: 'R2.01', label: 'R2.01 - Analyse (AN2)', coef21: 1.1, coef22: 0, category: 'Fondamentaux' },
            { id: 'R2.02', label: 'R2.02 - Culture Com (CC2)', coef21: 1.1, coef22: 0, category: 'Transverse' },
            { id: 'R2.03', label: 'R2.03 - Vie Entr. (VE2)', coef21: 0.8, coef22: 0, category: 'Transverse' },
            { id: 'R2.04', label: 'R2.04 - Outils Maths (OML2)', coef21: 2.6, coef22: 0, category: 'Fondamentaux' },
            { id: 'R2.05', label: 'R2.05 - PPP (PPP2)', coef21: 0.8, coef22: 0.2, category: 'Transverse' },
            { id: 'R2.06', label: 'R2.06 - Automatisme (AUTO2)', coef21: 0, coef22: 2.6, category: 'Technique' },
            { id: 'R2.07', label: 'R2.07 - Info Indus (INFO2)', coef21: 0, coef22: 2.6, category: 'Technique' },
            { id: 'R2.08', label: 'R2.08 - Élec/Énergie (ELEN2)', coef21: 1.3, coef22: 1.3, category: 'Technique' },
            { id: 'R2.09', label: 'R2.09 - Énergie (ENER2)', coef21: 1.3, coef22: 1.3, category: 'Technique' },
            { id: 'R2.10', label: 'R2.10 - Physique App (PApp2)', coef21: 0, coef22: 1.0, category: 'Fondamentaux' },
            { id: 'S2.1', label: 'SAÉ 2.1 - CAPA', coef21: 2.5, coef22: 2.5, category: 'SAÉ' },
            { id: 'S2.2', label: 'SAÉ 2.2 - Robot', coef21: 2.5, coef22: 2.5, category: 'SAÉ' },
            { id: 'PF2', label: 'Portfolio S2', coef21: 1.0, coef22: 1.0, category: 'SAÉ' },
        ];

        const INITIAL_TASKS = [
            { id: 1, title: 'QCM_TD1', deadline: '2026-02-13', type: 'QCM', done: false },
            { id: 2, title: 'QCM_TD2', deadline: '2026-03-04', type: 'QCM', done: false },
            { id: 3, title: 'QCM3 - Devoir (PDF/Image)', deadline: '2026-02-27', type: 'DEVOIR', done: false },
            { id: 4, title: 'QCM4', deadline: '2026-03-06', type: 'QCM', done: false },
            { id: 5, title: 'QCM5', deadline: '2026-03-13', type: 'QCM', done: false },
            { id: 6, title: 'QCM6', deadline: '2026-03-20', type: 'QCM', done: false },
            { id: 7, title: 'QCM_TD6', deadline: '2026-03-27', type: 'QCM', done: false },
            { id: 8, title: 'QCM_TD8', deadline: '2026-04-24', type: 'QCM', done: false },
            { id: 9, title: 'QCM_TD9', deadline: '2026-04-30', type: 'QCM', done: false },
            { id: 10, title: 'QCM_TD11', deadline: '2026-05-08', type: 'QCM', done: false },
            { id: 11, title: 'QCM_TD12', deadline: '2026-05-21', type: 'QCM', done: false },
        ];

        // --- COMPOSANTS UI ---

        const Icon = ({ name, size = 20, className = "" }) => {
            React.useEffect(() => {
                lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const Modal = ({ isOpen, onClose, title, children, isLoading }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto ai-border">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-bold text-white flex items-center gap-2">
                                    <span className="text-2xl">✨</span> {title}
                                </h3>
                                <button onClick={onClose} className="text-gray-400 hover:text-white transition-colors">
                                    <Icon name="x" size={24} />
                                </button>
                            </div>
                            <div className="text-gray-300 leading-relaxed whitespace-pre-wrap">
                                {isLoading ? (
                                    <div className="flex flex-col items-center justify-center py-10 gap-4">
                                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-500"></div>
                                        <p className="text-purple-300 animate-pulse">L'IA analyse vos données...</p>
                                    </div>
                                ) : (
                                    children
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TaskItem = ({ task, onToggle }) => {
            const today = new Date();
            const deadline = new Date(task.deadline);
            const diffTime = deadline - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let statusColor = "text-gray-400";
            let statusText = `${diffDays} jours restants`;
            let urgencyClass = "border-gray-700";

            if (task.done) {
                statusText = "Terminé";
                statusColor = "text-green-500";
                urgencyClass = "border-green-900 bg-green-900/10 opacity-50";
            } else if (diffDays < 0) {
                statusText = "En retard";
                statusColor = "text-red-500";
                urgencyClass = "border-red-900 bg-red-900/10";
            } else if (diffDays <= 3) {
                statusText = "URGENT !";
                statusColor = "text-red-400 font-bold animate-pulse";
                urgencyClass = "border-red-500 bg-red-500/10";
            } else if (diffDays <= 7) {
                statusText = "Bientôt";
                statusColor = "text-orange-400";
                urgencyClass = "border-orange-500/50";
            }

            return (
                <div className={`flex items-center justify-between p-3 mb-2 rounded-lg border glass-panel transition-all ${urgencyClass}`}>
                    <div className="flex items-center gap-3">
                        <button 
                            onClick={() => onToggle(task.id)}
                            className={`w-6 h-6 rounded border flex items-center justify-center transition-colors ${task.done ? 'bg-green-500 border-green-500' : 'border-gray-500 hover:border-blue-400'}`}
                        >
                            {task.done && <Icon name="check" size={14} className="text-white" />}
                        </button>
                        <div>
                            <p className={`font-medium ${task.done ? 'line-through text-gray-500' : 'text-gray-200'}`}>{task.title}</p>
                            <p className="text-xs text-gray-500 flex items-center gap-1">
                                <Icon name="calendar" size={10} /> {new Date(task.deadline).toLocaleDateString('fr-FR')}
                                <span className="mx-1">•</span>
                                <span className={task.type === 'DEVOIR' ? 'text-purple-400' : 'text-blue-400'}>{task.type}</span>
                            </p>
                        </div>
                    </div>
                    <div className={`text-xs text-right font-mono ${statusColor}`}>
                        {statusText}
                    </div>
                </div>
            );
        };

        // --- COMPOSANT PRINCIPAL ---

        const App = () => {
            // -- State --
            const [grades, setGrades] = useState({});
            const [tasks, setTasks] = useState(INITIAL_TASKS);
            
            // AI States
            const [modalOpen, setModalOpen] = useState(false);
            const [modalTitle, setModalTitle] = useState("");
            const [modalContent, setModalContent] = useState("");
            const [loadingAI, setLoadingAI] = useState(false);

            // -- Chargement/Sauvegarde --
            useEffect(() => {
                const savedGrades = localStorage.getItem('geii_grades');
                const savedTasks = localStorage.getItem('geii_tasks');
                if (savedGrades) setGrades(JSON.parse(savedGrades));
                if (savedTasks) setTasks(JSON.parse(savedTasks));
                lucide.createIcons();
            }, []);

            useEffect(() => {
                localStorage.setItem('geii_grades', JSON.stringify(grades));
            }, [grades]);

            useEffect(() => {
                localStorage.setItem('geii_tasks', JSON.stringify(tasks));
            }, [tasks]);

            // -- Handlers --
            const handleGradeChange = (id, value) => {
                let val = parseFloat(value);
                if (val < 0) val = 0;
                if (val > 20) val = 20;
                setGrades(prev => ({ ...prev, [id]: val }));
            };

            const toggleTask = (id) => {
                setTasks(prev => prev.map(t => t.id === id ? { ...t, done: !t.done } : t));
            };

            const resetData = () => {
                if(confirm("Attention: Cela va effacer toutes vos notes simulées. Continuer ?")) {
                    setGrades({});
                    localStorage.removeItem('geii_grades');
                }
            };

            // -- AI Logic --
            const handleAIAnalysis = async () => {
                setModalTitle("Analyse Stratégique du Coach IA");
                setModalOpen(true);
                setLoadingAI(true);

                const filledGrades = MODULES_CONFIG.map(m => `${m.id}: ${grades[m.id] || "Non noté"}`).join(", ");
                const upcomingTasks = tasks.filter(t => !t.done).map(t => `${t.title} (${t.deadline})`).join(", ");

                const prompt = `
                    Je suis étudiant en BUT GEII (Génie Électrique et Info Indus).
                    Voici mes notes actuelles : [${filledGrades}]
                    Voici mes tâches à venir : [${upcomingTasks}]
                    
                    Agis comme un coach académique bienveillant mais exigeant.
                    1. Analyse mes points forts et faibles actuels.
                    2. Donne-moi une stratégie en 3 points concrets pour réussir mon semestre.
                    3. Identifie ma priorité absolue pour les 7 prochains jours.
                    Utilise des emojis, sois concis et structuré.
                `;

                try {
                    const response = await callGemini(prompt, "Tu es un expert pédagogique en génie électrique et informatique.");
                    setModalContent(response);
                } catch (e) {
                    setModalContent("Erreur lors de la communication avec l'IA. Vérifiez votre connexion.");
                } finally {
                    setLoadingAI(false);
                }
            };

            const handleModuleHelp = async (module) => {
                setModalTitle(`Aide & Astuces : ${module.label}`);
                setModalOpen(true);
                setLoadingAI(true);

                const prompt = `
                    Explique brièvement ce qu'on étudie dans le module "${module.label}" en BUT GEII.
                    Donne 3 concepts clés difficiles souvent rencontrés par les étudiants.
                    Donne une astuce de révision spécifique ("Golden Tip") pour valider ce module.
                    Reste concis (max 150 mots).
                `;

                try {
                    const response = await callGemini(prompt, "Tu es un professeur de GEII expérimenté.");
                    setModalContent(response);
                } catch (e) {
                    setModalContent("Impossible de récupérer les infos du module.");
                } finally {
                    setLoadingAI(false);
                }
            };

            // -- Calculs --
            const calculateAverage = (ueType) => {
                let totalPoints = 0;
                let totalCoef = 0;
                
                MODULES_CONFIG.forEach(module => {
                    const coef = ueType === 'UE21' ? module.coef21 : module.coef22;
                    if (coef > 0) {
                        const grade = grades[module.id] !== undefined && !isNaN(grades[module.id]) ? grades[module.id] : null;
                        if (grade !== null) {
                            totalPoints += grade * coef;
                            totalCoef += coef;
                        }
                    }
                });
                return totalCoef === 0 ? "—" : (totalPoints / totalCoef).toFixed(2);
            };

            const avg21 = calculateAverage('UE21');
            const avg22 = calculateAverage('UE22');

            const getScoreColor = (score) => {
                if (score === "—") return "text-gray-500";
                const val = parseFloat(score);
                if (val < 10) return "text-red-500";
                if (val < 12) return "text-yellow-500";
                return "text-green-500";
            };

            return (
                <div className="min-h-screen pb-12">
                    <Modal 
                        isOpen={modalOpen} 
                        onClose={() => setModalOpen(false)} 
                        title={modalTitle}
                        isLoading={loadingAI}
                    >
                        {modalContent}
                    </Modal>

                    {/* Header */}
                    <header className="bg-gradient-to-r from-blue-900 via-slate-900 to-purple-900 border-b border-gray-800 p-6 shadow-lg">
                        <div className="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                                    <Icon name="cpu" className="text-blue-400" />
                                    My GEII Tracker <span className="text-xs bg-purple-600 px-2 py-0.5 rounded-full text-white ml-2">AI Powered ✨</span>
                                </h1>
                                <p className="text-blue-200 mt-1">Rafael GUILLAND-MILLE | BUT GEII - S2 2025/2026</p>
                            </div>
                            <div className="bg-slate-800/50 px-4 py-2 rounded-lg border border-slate-700 text-sm font-mono text-gray-300">
                                INE: 12506736
                            </div>
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        {/* COLONNE GAUCHE */}
                        <div className="lg:col-span-1 space-y-6">
                            
                            {/* Dashboard Cards */}
                            <div className="glass-panel p-6 rounded-xl shadow-xl relative overflow-hidden group">
                                <div className="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <Icon name="target" size={80} />
                                </div>
                                <h2 className="text-lg font-semibold mb-4 text-gray-200 border-b border-gray-700 pb-2">Synthèse S2</h2>
                                
                                <div className="space-y-6">
                                    <div className="text-center p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                        <p className="text-sm text-gray-400 mb-1">Moyenne UE21 (Concevoir)</p>
                                        <div className={`text-4xl font-bold ${getScoreColor(avg21)}`}>{avg21}</div>
                                    </div>
                                    
                                    <div className="text-center p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                        <p className="text-sm text-gray-400 mb-1">Moyenne UE22 (Vérifier)</p>
                                        <div className={`text-4xl font-bold ${getScoreColor(avg22)}`}>{avg22}</div>
                                    </div>
                                </div>

                                {/* BOUTON IA */}
                                <button 
                                    onClick={handleAIAnalysis}
                                    className="mt-6 w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white rounded-lg font-bold shadow-lg transform hover:scale-[1.02] transition-all flex items-center justify-center gap-2 group"
                                >
                                    <Icon name="sparkles" size={18} className="group-hover:animate-spin" />
                                    Analyser mon Semestre
                                </button>
                            </div>

                            {/* Task Manager */}
                            <div className="glass-panel p-6 rounded-xl shadow-xl">
                                <div className="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                                    <h2 className="text-lg font-semibold text-gray-200 flex items-center gap-2">
                                        <Icon name="bell-ring" className="text-yellow-500" size={18}/> 
                                        Rappels
                                    </h2>
                                    <span className="bg-blue-600 text-xs px-2 py-1 rounded-full text-white">
                                        {tasks.filter(t => !t.done).length}
                                    </span>
                                </div>
                                <div className="max-h-[400px] overflow-y-auto pr-1 custom-scrollbar">
                                    {tasks.sort((a,b) => new Date(a.deadline) - new Date(b.deadline)).map(task => (
                                        <TaskItem key={task.id} task={task} onToggle={toggleTask} />
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* COLONNE DROITE : CALCULATEUR */}
                        <div className="lg:col-span-2">
                            <div className="glass-panel p-6 rounded-xl shadow-xl">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 className="text-xl font-semibold text-white flex items-center gap-2">
                                            <Icon name="calculator" className="text-green-400" />
                                            Simulateur de Notes
                                        </h2>
                                        <p className="text-sm text-gray-400">Cliquez sur <Icon name="bot" size={14} className="inline text-purple-400"/> pour l'aide IA.</p>
                                    </div>
                                    <button onClick={resetData} className="text-xs text-red-400 hover:text-red-300 underline">
                                        Réinitialiser
                                    </button>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {MODULES_CONFIG.map(module => (
                                        <div key={module.id} className="bg-slate-800/40 p-3 rounded-lg border border-slate-700/50 hover:border-slate-600 transition-colors group relative">
                                            
                                            {/* AI Help Button */}
                                            <button 
                                                onClick={() => handleModuleHelp(module)}
                                                className="absolute top-2 right-2 text-slate-500 hover:text-purple-400 transition-colors"
                                                title="Demander à l'IA"
                                            >
                                                <Icon name="bot" size={16} />
                                            </button>

                                            <div className="flex justify-between items-start mb-2 pr-6">
                                                <div>
                                                    <span className="font-medium text-gray-200 block">{module.id}</span>
                                                    <span className="text-xs text-gray-400 block truncate max-w-[150px]" title={module.label}>{module.label.split('-')[1] || module.label}</span>
                                                </div>
                                            </div>
                                            
                                            <div className="flex items-center gap-2 mt-4">
                                                <input 
                                                    type="number" 
                                                    min="0" 
                                                    max="20" 
                                                    step="0.1"
                                                    placeholder="-"
                                                    className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-center text-white focus:outline-none focus:border-blue-500 transition-colors placeholder-gray-600 font-bold"
                                                    value={grades[module.id] || ''}
                                                    onChange={(e) => handleGradeChange(module.id, e.target.value)}
                                                />
                                                <span className="text-gray-500 font-mono text-sm">/20</span>
                                            </div>
                                            
                                            <div className="mt-2 flex gap-1 justify-end opacity-50 text-[10px]">
                                                 {module.coef21 > 0 && <span className="bg-blue-900/50 text-blue-300 px-1 rounded">UE21: x{module.coef21}</span>}
                                                 {module.coef22 > 0 && <span className="bg-purple-900/50 text-purple-300 px-1 rounded">UE22: x{module.coef22}</span>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
