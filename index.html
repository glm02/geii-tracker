<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GEII OS v9.6</title>
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut, getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy };
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: '#000000', // True Black
                        card: '#1C1C1E', // Apple/Revolut Dark Grey
                        cardHover: '#2C2C2E',
                        border: '#2C2C2E', // Subtle border
                        primary: '#2962FF', // Electric Blue
                        success: '#34C759', // iOS Green
                        danger: '#FF3B30', // iOS Red
                        warning: '#FFCC00', // iOS Yellow
                        text: '#FFFFFF',
                        subtext: '#8E8E93', // Cool Grey
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'San Francisco', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                    },
                    fontSize: {
                        'xxs': '0.65rem',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #000; color: #fff; -webkit-font-smoothing: antialiased; }
        /* Fintech Card Style: Solid, subtle border, rounded */
        .fintech-card { 
            background-color: #1C1C1E; 
            border-radius: 1.5rem; /* Rounded-3xl roughly */
            /* No heavy border, just cleaner look */
        }
        .fintech-card:active { transform: scale(0.98); transition: transform 0.1s ease; }
        
        .glass-modal { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .page-enter { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Typography Polish */
        h1, h2, h3, .font-bold { letter-spacing: -0.02em; } 
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIG & DATA ---
        const DEFAULT_ADE = "https://edt.univ-lyon1.fr/jsp/custom/modules/plannings/anonymous_cal.jsp?resources=13655&projectId=1&calType=ical&firstDate=2025-08-18&lastDate=2026-08-01";
        
        const LINKS = {
            ADE: "https://edt.univ-lyon1.fr/direct/index.jsp?projectId=1&ShowPianoWeeks=true&resources=13655&displayConfName=_DirectPlanning_IUT-GEII&days=0,1,2,3,4&weeks=&from=edt",
            MAIL: "https://mail.univ-lyon1.fr/owa/auth/logon.aspx?url=https%3a%2f%2fmail.univ-lyon1.fr%2fowa%2f&reason=0",
            DOCS: "https://wwwgeii.univ-lyon1.fr/depot_certif/view_user_docs.php",
            MOODLE: "https://moodle.univ-lyon1.fr/",
            MIRE: "https://wwwgeii.univ-lyon1.fr/mire_geii.php",
            CROUS: "https://www.crous-lyon.fr/restaurant/resto-u-gratte-ciel/",
            MEDIA: "https://mediatheques.villeurbanne.fr/",
            TCL: "https://www.tcl.fr/se-deplacer/info-trafic"
        };

        const USEFUL_LINKS = [
            { name: 'Moodle', url: LINKS.MOODLE, color: 'bg-orange-500', icon: 'graduation-cap' },
            { name: 'Mire GEII', url: LINKS.MIRE, color: 'bg-emerald-500', icon: 'file-text' },
            { name: 'ADE Direct', url: LINKS.ADE, color: 'bg-indigo-500', icon: 'calendar' },
            { name: 'Mail Univ', url: LINKS.MAIL, color: 'bg-sky-500', icon: 'mail' },
            { name: 'Justificatifs', url: LINKS.DOCS, color: 'bg-purple-500', icon: 'paperclip' },
            { name: 'Info Trafic TCL', url: LINKS.TCL, color: 'bg-red-500', icon: 'train' }
        ];

        const MODULES_CONFIG_S2 = [
            { id: 'R2.01', short: 'AN2', label: 'Analyse', coef21: 1.1, coef22: 0, cat: 'Fonda' },
            { id: 'R2.02', short: 'CC2', label: 'Culture Com', coef21: 1.1, coef22: 0, cat: 'Trans' },
            { id: 'R2.03', short: 'VE2', label: 'Vie Entreprise', coef21: 0.8, coef22: 0, cat: 'Trans' },
            { id: 'R2.04', short: 'OML2', label: 'Outils Maths', coef21: 2.6, coef22: 0, cat: 'Fonda' },
            { id: 'R2.05', short: 'PPP2', label: 'Projet Pro', coef21: 0.8, coef22: 0.2, cat: 'Trans' },
            { id: 'R2.06', short: 'AUTO2', label: 'Automatisme', coef21: 0, coef22: 2.6, cat: 'Tech' },
            { id: 'R2.07', short: 'INFO2', label: 'Info Indus', coef21: 0, coef22: 2.6, cat: 'Tech' },
            { id: 'R2.08', short: 'ELEN2', label: 'Ã‰lec/Ã‰nergie', coef21: 1.3, coef22: 1.3, cat: 'Tech' },
            { id: 'R2.09', short: 'ENER2', label: 'Ã‰nergie', coef21: 1.3, coef22: 1.3, cat: 'Tech' },
            { id: 'R2.10', short: 'PApp2', label: 'Physique App', coef21: 0, coef22: 1.0, cat: 'Fonda' },
            { id: 'S2.1', short: 'SAÃ‰ 2.1', label: 'SAÃ‰ CAPA', coef21: 2.5, coef22: 2.5, cat: 'SAÃ‰' },
            { id: 'S2.2', short: 'SAÃ‰ 2.2', label: 'SAÃ‰ Robot', coef21: 2.5, coef22: 2.5, cat: 'SAÃ‰' },
            { id: 'PF2', short: 'PORTF', label: 'Portfolio S2', coef21: 1.0, coef22: 1.0, cat: 'SAÃ‰' },
        ];

        const TASKS_DATA = [
            { module: 'R2.09', title: 'QCM_TD1', end: '2026-02-13', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD2', end: '2026-03-04', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD3', end: '2026-03-06', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD4', end: '2026-03-13', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD6', end: '2026-03-27', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD8', end: '2026-04-24', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD9', end: '2026-04-30', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD11', end: '2026-05-08', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD12', end: '2026-05-21', type: 'QCM' },
            { module: 'R2.10', title: 'QCM1_SÃ©ance 1', end: '2026-02-06', type: 'QCM' },
            { module: 'R2.10', title: 'QCM2_SÃ©ance 2', end: '2026-02-13', type: 'QCM' },
            { module: 'R2.10', title: 'QCM3 - Devoir', end: '2026-02-27', type: 'DEVOIR' },
            { module: 'R2.10', title: 'QCM4', end: '2026-03-06', type: 'QCM' },
            { module: 'R2.10', title: 'QCM5', end: '2026-03-13', type: 'QCM' },
            { module: 'R2.10', title: 'QCM6', end: '2026-03-20', type: 'QCM' },
            { module: 'R2.10', title: 'QCM7', end: '2026-03-28', type: 'QCM' },
            { module: 'R2.10', title: 'QCM8', end: '2026-04-04', type: 'QCM' },
            { module: 'R2.10', title: 'QCM10', end: '2026-04-18', type: 'QCM' },
            { module: 'R2.10', title: 'QCM11', end: '2026-05-09', type: 'QCM' },
            { module: 'R2.10', title: 'QCM12', end: '2026-05-16', type: 'QCM' },
            { module: 'R2.10', title: 'QCM13', end: '2026-05-23', type: 'QCM' },
            { module: 'R2.10', title: 'QCM14', end: '2026-05-30', type: 'QCM' },
        ];
        
        const startDate = new Date('2026-02-02');
        for(let i=0; i<10; i++) {
            let d1 = new Date(startDate); d1.setDate(startDate.getDate() + (i*7));
            let d2 = new Date(startDate); d2.setDate(startDate.getDate() + (i*7) + 3);
            TASKS_DATA.push({ module: 'R2.04', title: `QCM Hebdo ${i+1}.1`, end: d1.toISOString().split('T')[0], type: 'MATHS' });
            TASKS_DATA.push({ module: 'R2.04', title: `QCM Hebdo ${i+1}.2`, end: d2.toISOString().split('T')[0], type: 'MATHS' });
        }

        // --- HELPERS ---
        const Icon = ({ name, size=20, className="" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const calcAvg = (grades) => {
            if (!grades || grades.length === 0) return null;
            let p = 0, c = 0;
            grades.forEach(g => { p += parseFloat(g.value) * parseFloat(g.coef); c += parseFloat(g.coef); });
            return c === 0 ? 0 : (p / c).toFixed(2);
        };

        const getGradeColor = (val) => {
            if (val === null || val === "â€”") return "text-subtext";
            const v = parseFloat(val);
            if (v < 8) return "text-danger"; if (v < 10) return "text-warning"; if (v < 14) return "text-primary"; return "text-success";
        };

        const getModuleName = (id) => {
            const mod = MODULES_CONFIG_S2.find(m => m.id === id);
            return mod ? mod.label : id;
        };

        const parseICS = (icsData) => {
            const events = [];
            const lines = icsData.split(/\r\n|\n|\r/);
            let inEvent = false;
            let event = {};
            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                dateStr = dateStr.trim();
                const match = dateStr.match(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?/);
                if (!match) return null;
                const [, y, m, d, h, min, s, z] = match;
                if (z) return new Date(Date.UTC(y, m-1, d, h, min, s));
                else return new Date(y, m-1, d, h, min, s);
            };
            for (let line of lines) {
                if (line.startsWith('BEGIN:VEVENT')) { inEvent = true; event = {}; } 
                else if (line.startsWith('END:VEVENT')) { inEvent = false; if (event.start && event.summary) events.push(event); } 
                else if (inEvent) {
                    if (line.startsWith('DTSTART')) { const parts = line.split(':'); if(parts.length > 1) event.start = parseDate(parts[1]); }
                    else if (line.startsWith('DTEND')) { const parts = line.split(':'); if(parts.length > 1) event.end = parseDate(parts[1]); }
                    else if (line.startsWith('SUMMARY')) { event.summary = line.split(':')[1]?.replace(/\\,/g, ',') || 'Cours'; }
                    else if (line.startsWith('LOCATION')) { event.location = line.split(':')[1]?.replace(/\\,/g, ',') || ''; }
                }
            }
            return events;
        };

        // --- COMPONENTS ---

        const BottomNav = ({ active, setView }) => (
            <div className="fixed bottom-0 w-full bg-[#121212]/90 backdrop-blur-xl border-t border-white/5 pb-safe pt-2 px-6 flex justify-between z-50">
                {[{ id: 'HOME', icon: 'layout-grid', label: 'Accueil' }, { id: 'NOTES', icon: 'graduation-cap', label: 'Notes' }, { id: 'AGENDA', icon: 'calendar', label: 'Agenda' }, { id: 'LIFE', icon: 'coffee', label: 'Campus' }, { id: 'SETTINGS', icon: 'user', label: 'Profil' }].map(item => (
                    <button key={item.id} onClick={() => setView(item.id)} className={`flex flex-col items-center p-2 transition-all duration-200 active:scale-90 ${active === item.id ? 'text-primary' : 'text-subtext hover:text-white'}`}>
                        <Icon name={item.icon} size={22} className={`mb-1 ${active === item.id ? 'stroke-[2.5px]' : 'stroke-[1.5px]'}`}/>
                        <span className="text-[10px] font-medium tracking-tight">{item.label}</span>
                    </button>
                ))}
            </div>
        );

        const GradeEditorModal = ({ module, grades, onClose, onSave }) => {
            const [localGrades, setLocalGrades] = useState(grades || []);
            const [val, setVal] = useState('');
            const [coef, setCoef] = useState('1');
            const [name, setName] = useState('');

            const add = () => { if(val) { const next=[...localGrades,{id:Date.now(),value:val,coef:coef,name:name||'Note'}]; setLocalGrades(next); onSave(next); setVal(''); setName(''); }};
            const remove = (id) => { const next=localGrades.filter(g=>g.id!==id); setLocalGrades(next); onSave(next); };
            const avg = calcAvg(localGrades) || "â€”";

            return (
                <div className="fixed inset-0 z-[60] flex items-end justify-center glass-modal animate-in fade-in duration-200">
                    <div className="bg-card w-full max-w-md rounded-t-[2rem] border-t border-white/10 flex flex-col max-h-[90vh]">
                        <div className="p-6 flex justify-between items-center border-b border-white/5 bg-[#1C1C1E]">
                            <div><h3 className="font-bold text-xl text-white tracking-tight">{module.label} <span className={`ml-2 text-2xl font-mono ${getGradeColor(avg)}`}>{avg}</span></h3><p className="text-xs text-subtext uppercase tracking-wider font-semibold mt-1">{module.id} â€¢ {module.cat}</p></div>
                            <button onClick={onClose} className="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition-colors"><Icon name="x" size={18}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto pb-safe space-y-6">
                            <div className="bg-primary/5 p-5 rounded-2xl border border-primary/20 space-y-4">
                                <label className="text-xs font-bold text-primary uppercase tracking-wider">Ajouter une note</label>
                                <div className="flex gap-3">
                                    <input value={name} onChange={e=>setName(e.target.value)} placeholder="Titre (ex: DS1)" className="flex-1 bg-black/50 border border-white/10 rounded-xl p-3 text-sm focus:border-primary outline-none placeholder-white/20" />
                                    <input type="number" value={val} onChange={e=>setVal(e.target.value)} placeholder="20" className="w-16 bg-black/50 border border-white/10 rounded-xl p-3 text-sm font-bold text-center focus:border-primary outline-none placeholder-white/20" />
                                    <input type="number" value={coef} onChange={e=>setCoef(e.target.value)} placeholder="1" className="w-14 bg-black/50 border border-white/10 rounded-xl p-3 text-sm text-center text-subtext focus:border-primary outline-none placeholder-white/20" />
                                </div>
                                <button onClick={add} className="w-full bg-primary text-white py-3.5 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 hover:bg-primary/90 transition-all active:scale-95">Confirmer</button>
                            </div>
                            <div className="space-y-3">
                                <label className="text-xs font-bold text-subtext uppercase tracking-wider px-1">Historique</label>
                                {localGrades.length===0 ? <p className="text-center text-sm text-subtext py-6 bg-white/5 rounded-xl border-dashed border border-white/10">Aucune note enregistrÃ©e</p> : localGrades.slice().reverse().map(g=>(
                                    <div key={g.id} className="flex justify-between items-center bg-[#252525] p-4 rounded-xl border border-white/5">
                                        <div><div className="font-bold text-sm text-white">{g.name}</div><div className="text-xs text-subtext font-medium mt-0.5">Coef {g.coef}</div></div>
                                        <div className="flex items-center gap-4"><span className={`font-mono font-bold text-lg ${getGradeColor(g.value)}`}>{g.value}</span><button onClick={()=>remove(g.id)} className="text-danger opacity-40 hover:opacity-100 transition-opacity"><Icon name="trash-2" size={18}/></button></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SemesterSelector = ({ current, onChange }) => (
            <div className="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
                {[1, 2, 3, 4].map(s => (
                    <button key={s} onClick={() => onChange(s)} className={`px-5 py-2.5 rounded-full text-xs font-bold border transition-all whitespace-nowrap ${current === s ? 'bg-white text-black border-white' : 'bg-[#1C1C1E] border-white/10 text-subtext hover:text-white'}`}>
                        Semestre {s}
                    </button>
                ))}
            </div>
        );

        const HistoryInput = ({ label, value, onChange }) => (
            <div className="fintech-card p-5 border border-white/5 flex justify-between items-center">
                <span className="font-bold text-sm text-subtext">{label}</span>
                <input type="number" value={value || ''} onChange={e => onChange(e.target.value)} className="w-20 bg-black/50 border border-white/10 rounded-lg p-2.5 text-center font-mono font-bold text-white focus:border-primary outline-none" placeholder="--" />
            </div>
        );

        const TargetSimulator = () => {
            const [currentAvg, setCurrentAvg] = useState('');
            const [target, setTarget] = useState('');
            const [coefNext, setCoefNext] = useState('');
            const [result, setResult] = useState(null);

            const calculate = () => {
                const cur = parseFloat(currentAvg);
                const tar = parseFloat(target);
                const coef = parseFloat(coefNext);
                if (cur && tar && coef) {
                    const needed = ((tar * (1 + coef)) - cur) / coef;
                    setResult(needed.toFixed(2));
                }
            };

            return (
                <div className="fintech-card p-5 border border-white/5 space-y-4">
                    <h3 className="font-bold text-sm flex gap-2 text-primary uppercase tracking-wider items-center"><Icon name="target" size={16}/> Simulateur Objectif</h3>
                    <div className="flex gap-3">
                        <div className="flex-1 space-y-1">
                            <label className="text-[10px] text-subtext uppercase font-bold">Actuel</label>
                            <input type="number" value={currentAvg} onChange={e=>setCurrentAvg(e.target.value)} className="w-full bg-black/50 p-2.5 rounded-lg text-sm border border-white/10 text-white font-mono placeholder-white/20"/>
                        </div>
                         <div className="flex-1 space-y-1">
                            <label className="text-[10px] text-subtext uppercase font-bold">Cible</label>
                            <input type="number" value={target} onChange={e=>setTarget(e.target.value)} className="w-full bg-black/50 p-2.5 rounded-lg text-sm border border-white/10 text-white font-mono placeholder-white/20"/>
                        </div>
                         <div className="w-16 space-y-1">
                            <label className="text-[10px] text-subtext uppercase font-bold">Coef</label>
                            <input type="number" value={coefNext} onChange={e=>setCoefNext(e.target.value)} className="w-full bg-black/50 p-2.5 rounded-lg text-sm border border-white/10 text-white font-mono placeholder-white/20"/>
                        </div>
                    </div>
                    <div className="flex items-center justify-between pt-2">
                        <button onClick={calculate} className="bg-white/10 py-2 px-4 rounded-lg text-xs font-bold hover:bg-white/20 transition-colors">Calculer</button>
                        {result && <div className="text-sm font-medium">Il faut : <span className={`font-bold font-mono text-lg ml-1 ${result > 20 ? 'text-danger' : 'text-success'}`}>{result}/20</span></div>}
                    </div>
                </div>
            );
        };

        const AgendaList = ({ events, profile, onExpand }) => {
            const [weekOffset, setWeekOffset] = useState(0);

            const getWeekRange = (offset) => {
                const now = new Date();
                const day = now.getDay(); 
                const diff = now.getDate() - day + (day === 0 ? -6 : 1) + (offset * 7);
                const monday = new Date(now.setDate(diff));
                monday.setHours(0,0,0,0);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23,59,59,999);
                return { start: monday, end: sunday };
            };

            const { start, end } = getWeekRange(weekOffset);
            const weekEvents = events.filter(e => e.start >= start && e.start <= end);

            const grouped = weekEvents.reduce((acc, event) => {
                const dateKey = event.start.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                if (!acc[dateKey]) acc[dateKey] = [];
                acc[dateKey].push(event);
                return acc;
            }, {});

            // Sort keys
            const sortedDates = Object.keys(grouped).sort((a,b) => grouped[a][0].start - grouped[b][0].start);

            const getCourseStyle = (summary) => {
                const s = summary.toLowerCase();
                if (s.includes('ds') || s.includes('exam') || s.includes('controle')) return { type: 'EXAMEN', color: 'border-l-danger bg-danger/5 text-danger', badge: 'bg-danger/10 text-danger border border-danger/20' };
                if (s.includes('amphi') || s.includes('cm')) return { type: 'CM', color: 'border-l-purple-500 bg-purple-500/5', badge: 'bg-purple-500/10 text-purple-400 border border-purple-500/20' };
                if (s.includes('tp')) return { type: 'TP', color: 'border-l-blue-500 bg-blue-500/5', badge: 'bg-blue-500/10 text-blue-400 border border-blue-500/20' };
                if (s.includes('td')) return { type: 'TD', color: 'border-l-green-500 bg-green-500/5', badge: 'bg-green-500/10 text-green-400 border border-green-500/20' };
                return { type: 'Cours', color: 'border-l-white/20 bg-white/5', badge: 'bg-white/10 text-subtext border border-white/10' };
            };

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center fintech-card p-3 border border-white/5">
                        <button onClick={() => setWeekOffset(weekOffset - 1)} className="p-2 hover:bg-white/10 rounded-lg transition-colors"><Icon name="chevron-left" size={20}/></button>
                        <div className="text-center">
                            <div className="text-[10px] text-subtext uppercase font-bold tracking-wider">Semaine du</div>
                            <div className="text-sm font-bold text-white">{start.toLocaleDateString('fr-FR', {day: 'numeric', month: 'short'})}</div>
                        </div>
                        <button onClick={() => setWeekOffset(weekOffset + 1)} className="p-2 hover:bg-white/10 rounded-lg transition-colors"><Icon name="chevron-right" size={20}/></button>
                    </div>

                    {onExpand && (
                    <div className="flex justify-end">
                        <button onClick={onExpand} className="bg-white/5 border border-white/10 text-xs font-bold px-3 py-2 rounded-lg flex items-center gap-2 hover:bg-white/10 transition-colors uppercase tracking-wider text-subtext hover:text-white">
                            <Icon name="maximize-2" size={12}/> Agrandir
                        </button>
                    </div>
                    )}

                    {sortedDates.length === 0 ? (
                        <div className="text-center py-12 text-subtext flex flex-col items-center gap-3 opacity-50">
                            <Icon name="coffee" size={32}/>
                            <span className="text-sm font-medium">Semaine libre !</span>
                        </div>
                    ) : (
                        sortedDates.map((date, index) => {
                            const dayEvents = grouped[date];
                            return (
                                <div key={index} className="animate-in slide-in-from-bottom-4 fade-in duration-500">
                                    <h3 className="text-xs font-bold text-primary uppercase sticky top-0 bg-bg/95 backdrop-blur-xl py-3 z-10 flex items-center gap-2 border-b border-transparent">
                                        <div className="w-1.5 h-1.5 rounded-full bg-primary"></div> {date}
                                    </h3>
                                    <div className="space-y-3 mt-1">
                                        {dayEvents.map((e, i) => {
                                            const style = getCourseStyle(e.summary);
                                            const now = new Date();
                                            const isLive = now >= e.start && now <= e.end;
                                            
                                            return (
                                                <div key={i} className={`relative fintech-card p-4 border border-white/5 border-l-4 ${style.color} ${isLive ? 'ring-1 ring-primary/50 shadow-[0_0_15px_rgba(59,130,246,0.3)]' : ''}`}>
                                                    {isLive && <div className="absolute top-3 right-3 px-2 py-0.5 bg-primary text-white text-[9px] font-bold rounded-full animate-pulse shadow-lg shadow-primary/40">EN COURS</div>}
                                                    <div className="flex gap-4">
                                                        <div className="flex flex-col items-center justify-center min-w-[50px] border-r border-white/5 pr-4 py-1">
                                                            <span className="font-bold text-sm text-white">{e.start.getHours()}h{e.start.getMinutes().toString().padStart(2, '0')}</span>
                                                            <div className="h-4 w-0.5 bg-white/10 rounded-full my-0.5"></div>
                                                            <span className="text-[10px] text-subtext font-medium">{e.end.getHours()}h{e.end.getMinutes().toString().padStart(2, '0')}</span>
                                                        </div>
                                                        <div className="overflow-hidden flex-1 flex flex-col justify-center">
                                                            <div className="font-bold text-sm text-white truncate pr-8 leading-tight mb-1.5">{e.summary}</div>
                                                            <div className="flex items-center gap-2">
                                                                <span className={`text-[9px] px-1.5 py-0.5 rounded font-bold tracking-wide uppercase ${style.badge}`}>{style.type}</span>
                                                                <div className="text-xs text-subtext truncate flex gap-1 items-center font-medium"><Icon name="map-pin" size={10}/> {e.location || 'Salle inconnue'}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })
                    )}
                </div>
            );
        };

        const QCMList = ({ tasks, taskStatus, onToggle }) => {
            const allTasks = [...tasks].sort((a,b) => new Date(a.end) - new Date(b.end));
            const now = new Date();

            return (
                <div className="space-y-2">
                    {allTasks.map((task, i) => {
                        const uid = task.title + task.module;
                        const isDone = taskStatus[uid];
                        const deadline = new Date(task.end);
                        const diffDays = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                        let color = "text-subtext", text = `${diffDays}j`;
                        if (isDone) { text = "Fait"; color = "text-success"; }
                        else if (diffDays < 0) { text = "Retard"; color = "text-danger"; }
                        else if (diffDays <= 3) { text = `J-${diffDays}`; color = "text-danger font-bold"; }
                        else if (diffDays <= 7) { text = `J-${diffDays}`; color = "text-warning"; }

                        return (
                            <div key={i} onClick={() => onToggle(uid)} className={`flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all active:scale-98 ${isDone ? 'bg-black/30 border-white/5 opacity-50' : 'fintech-card border-white/5 hover:bg-cardHover'}`}>
                                <div className="flex items-center gap-4">
                                    <div className={`w-5 h-5 rounded-full border flex items-center justify-center transition-colors ${isDone ? 'bg-success border-success' : 'border-subtext/50'}`}>{isDone && <Icon name="check" size={12} className="text-black stroke-[3px]"/>}</div>
                                    <div>
                                        <div className={`font-bold text-sm ${isDone ? 'line-through text-subtext' : 'text-white'}`}>{task.title}</div>
                                        <div className="text-xs text-subtext font-medium mt-0.5 flex gap-1.5 items-center">
                                            <span className="bg-white/10 px-1.5 py-0 rounded text-[9px] text-white/80">{getModuleName(task.module)}</span>
                                            <span>{new Date(task.end).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div className={`text-xs font-mono font-bold ${color}`}>{text}</div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const PomodoroWidget = () => {
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [isBreak, setIsBreak] = useState(false);

            useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) {
                    interval = setInterval(() => setTimeLeft(timeLeft - 1), 1000);
                } else if (timeLeft === 0) {
                    setIsActive(false);
                    setIsBreak(!isBreak);
                    setTimeLeft(isBreak ? 25 * 60 : 5 * 60);
                }
                return () => clearInterval(interval);
            }, [isActive, timeLeft, isBreak]);

            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const progress = 100 - (timeLeft / (isBreak ? 5*60 : 25*60)) * 100;

            return (
                <div onClick={(e) => e.stopPropagation()} className="w-full h-full flex flex-col justify-between items-center">
                     <div className="text-xs font-bold uppercase text-subtext mb-1 flex items-center gap-1">{isBreak ? 'Pause â˜•' : 'Focus ðŸ”¥'}</div>
                     <div className="relative w-20 h-20 flex items-center justify-center">
                        <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
                            <path className="text-white/10" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="2"/>
                            <path className={`${isBreak ? 'text-green-500' : 'text-danger'} transition-all duration-1000`} strokeDasharray={`${progress}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="2"/>
                        </svg>
                        <div className="text-lg font-mono font-bold tracking-tighter">{minutes}:{seconds < 10 ? `0${seconds}` : seconds}</div>
                     </div>
                     <button 
                        onClick={() => setIsActive(!isActive)} 
                        className={`w-full py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-colors ${isActive ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-primary hover:bg-blue-600 text-white'}`}
                     >
                        {isActive ? 'Pause' : 'Start'}
                     </button>
                </div>
            );
        };

        const WeatherWidget = () => {
            const [data, setData] = useState(null);
            useEffect(() => {
                fetch('https://api.open-meteo.com/v1/forecast?latitude=45.77&longitude=4.88&current_weather=true')
                    .then(res => res.json())
                    .then(d => setData({ temp: Math.round(d.current_weather.temperature), icon: 'sun' })).catch(()=>{});
            }, []);
            return (
                <div className="fintech-card p-4 flex flex-col justify-between h-full border border-white/5">
                    <div className="flex justify-between items-start">
                        <div className="text-xs text-subtext font-bold uppercase tracking-wider">MÃ©tÃ©o</div>
                        <Icon name="cloud-sun" size={20} className="text-yellow-400"/>
                    </div>
                    <div>
                        <div className="text-3xl font-bold tracking-tighter">{data?.temp || '--'}Â°</div>
                        <div className="text-[10px] text-subtext font-medium mt-1">Villeurbanne</div>
                    </div>
                </div>
            );
        };

        const SemesterProgress = () => {
            const start = new Date('2026-01-05').getTime();
            const end = new Date('2026-06-30').getTime();
            const now = new Date().getTime();
            const progress = Math.min(100, Math.max(0, ((now - start) / (end - start)) * 100));
            
            return (
                <div className="fintech-card p-5 border border-white/5">
                    <div className="flex justify-between items-end mb-3">
                        <span className="text-xs text-subtext font-bold uppercase tracking-wider">Semestre 2</span>
                        <span className="text-xs font-mono font-bold text-primary">{Math.round(progress)}%</span>
                    </div>
                    <div className="w-full bg-black/50 rounded-full h-2 overflow-hidden border border-white/5">
                        <div className="bg-primary h-2 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(59,130,246,0.5)]" style={{width: `${progress}%`}}></div>
                    </div>
                </div>
            );
        };

        const UpcomingDeadline = ({ tasks, taskStatus }) => {
            const now = new Date();
            const upcoming = tasks
                .filter(t => !taskStatus[t.title+t.module])
                .map(t => ({...t, diff: new Date(t.end) - now}))
                .filter(t => t.diff > 0)
                .sort((a,b) => a.diff - b.diff)[0];

            if (!upcoming) return <div className="fintech-card p-4 flex items-center justify-center text-xs text-subtext border border-white/5 h-full">Aucun devoir ðŸ”¥</div>;

            const days = Math.ceil(upcoming.diff / (1000 * 60 * 60 * 24));
            
            return (
                <div className="fintech-card p-4 flex flex-col justify-between border border-white/5 border-l-4 border-l-warning h-full">
                    <div className="flex justify-between items-start">
                        <span className="text-xs font-bold text-warning uppercase tracking-wider">Urgent</span>
                        <span className="text-[10px] bg-warning/10 text-warning px-2 py-0.5 rounded-full font-bold">J-{days}</span>
                    </div>
                    <div>
                        <div className="font-bold text-sm truncate">{upcoming.title}</div>
                        <div className="text-[10px] text-subtext font-medium mt-0.5">{getModuleName(upcoming.module)}</div>
                    </div>
                </div>
            );
        };

        const Scratchpad = ({ note, onChange }) => (
            <div className="fintech-card p-4 flex flex-col gap-2 border border-white/5 h-full">
                <div className="flex items-center gap-2 text-xs font-bold text-subtext uppercase tracking-wider">
                    <Icon name="edit-3" size={14}/> Notes
                </div>
                <textarea 
                    value={note} 
                    onChange={e => onChange(e.target.value)} 
                    placeholder="Code, salle, mÃ©mo..." 
                    className="bg-transparent border-none outline-none text-xs resize-none h-full w-full text-white placeholder-white/20 leading-relaxed font-medium"
                />
            </div>
        );

        const CrousWidget = () => {
            const hour = new Date().getHours();
            const isOpen = hour >= 11 && hour < 14;
            return (
                <a href={LINKS.CROUS} target="_blank" className="fintech-card p-5 border border-white/5 flex flex-col justify-between active:scale-95 transition-transform hover:bg-cardHover">
                    <div className="flex justify-between items-start">
                        <div className="w-10 h-10 rounded-full bg-orange-500/10 flex items-center justify-center text-orange-500"><Icon name="utensils" size={20}/></div>
                        <span className={`text-[10px] px-2 py-1 rounded-full font-bold ${isOpen ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}`}>
                            {isOpen ? 'OUVERT' : 'FERMÃ‰'}
                        </span>
                    </div>
                    <div>
                        <div className="font-bold text-base mt-2">Resto U</div>
                        <div className="text-xs text-subtext font-medium flex items-center gap-1 mt-1">Menu du jour <Icon name="arrow-up-right" size={10}/></div>
                    </div>
                </a>
            );
        };

        const TrafficWidget = () => (
            <a href={LINKS.TCL} target="_blank" className="fintech-card p-5 border border-white/5 flex flex-col justify-between active:scale-95 transition-transform hover:bg-cardHover">
                <div className="flex justify-between items-start">
                    <div className="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center text-red-500"><Icon name="train" size={20}/></div>
                    <div className="flex gap-1.5">
                        <span className="w-2 h-2 rounded-full bg-success"></span>
                        <span className="w-2 h-2 rounded-full bg-warning animate-pulse"></span>
                    </div>
                </div>
                <div>
                    <div className="font-bold text-base mt-2">Info Trafic</div>
                    <div className="text-xs text-subtext font-medium flex items-center gap-1 mt-1">TCL Direct <Icon name="arrow-up-right" size={10}/></div>
                </div>
            </a>
        );

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('HOME');
            const [user, setUser] = useState(null);
            const [semester, setSemester] = useState(2);
            const [visibleUEs, setVisibleUEs] = useState({ 21: true, 22: true });
            const [events, setEvents] = useState([]);
            const [allEvents, setAllEvents] = useState([]); 
            const [announcements, setAnnouncements] = useState([]);
            const [profile, setProfile] = useState({ firstName: 'Ã‰tudiant', lastName: '', group: '', email: '', ine: '', adeUrl: DEFAULT_ADE });
            const [history, setHistory] = useState({ s1: { ue11: '', ue12: '' }, s3: { ue31: '', ue32: '' }, s4: { ue41: '', ue42: '' } });
            const [s2Grades, setS2Grades] = useState({});
            const [taskStatus, setTaskStatus] = useState({});
            const [quickNote, setQuickNote] = useState('');
            const [selectedModule, setSelectedModule] = useState(null);
            const [customLinks, setCustomLinks] = useState([]);
            const [showMap, setShowMap] = useState(false);
            
            const dbRef = useRef(null);
            const appIdRef = useRef(typeof __app_id !== 'undefined' ? __app_id : 'default-fintech-app');

            // --- DATA LOADING ---
            useEffect(() => {
                const init = async () => {
                    const fallbackToLocal = () => {
                        const local = JSON.parse(localStorage.getItem('geii_v9_local') || '{}');
                        if (local.profile) setProfile(local.profile);
                        if (local.s2Grades) setS2Grades(local.s2Grades);
                        if (local.history) setHistory(local.history);
                        if (local.taskStatus) setTaskStatus(local.taskStatus);
                        if (local.quickNote) setQuickNote(local.quickNote);
                        if (local.customLinks) setCustomLinks(local.customLinks);
                        setUser({ uid: 'local_mode_user' });
                    };

                    if (typeof __firebase_config === 'undefined' || !__firebase_config) return fallbackToLocal();

                    let attempts = 0;
                    while (!window.firebaseModules && attempts < 20) { await new Promise(r => setTimeout(r, 100)); attempts++; }
                    if (!window.firebaseModules) return fallbackToLocal();

                    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, onSnapshot, collection, query, orderBy } = window.firebaseModules;
                    
                    try {
                        const app = initializeApp(JSON.parse(__firebase_config));
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        dbRef.current = db;
                        
                        await signInAnonymously(auth);
                        
                        onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                const userDocRef = doc(db, 'artifacts', appIdRef.current, 'users', u.uid, 'data', 'main');
                                onSnapshot(userDocRef, (snap) => {
                                    if (snap.exists()) {
                                        const d = snap.data();
                                        if (d.s2Grades) setS2Grades(d.s2Grades);
                                        if (d.profile) setProfile(d.profile);
                                        if (d.history) setHistory(d.history);
                                        if (d.taskStatus) setTaskStatus(d.taskStatus);
                                        if (d.quickNote) setQuickNote(d.quickNote);
                                        if (d.customLinks) setCustomLinks(d.customLinks);
                                    }
                                }, () => fallbackToLocal());

                                const q = query(collection(db, 'artifacts', appIdRef.current, 'public', 'data', 'announcements'));
                                onSnapshot(q, (snap) => {
                                    const msgs = [];
                                    snap.forEach(d => msgs.push(d.data()));
                                    setAnnouncements(msgs);
                                }, () => {}); 
                            } else fallbackToLocal();
                        });
                    } catch (e) { fallbackToLocal(); }
                };
                init();
            }, []);

            // Save Data
            useEffect(() => {
                if (!user) return;
                const data = { profile, s2Grades, history, taskStatus, quickNote, customLinks };
                localStorage.setItem('geii_v9_local', JSON.stringify(data));
                if (dbRef.current && user.uid !== 'local_mode_user') {
                    const { doc, setDoc } = window.firebaseModules;
                    setDoc(doc(dbRef.current, 'artifacts', appIdRef.current, 'users', user.uid, 'data', 'main'), data, { merge: true }).catch(()=>{});
                }
            }, [profile, s2Grades, history, taskStatus, quickNote, customLinks, user]);

            // Agenda Fetch - Full Week
            useEffect(() => {
                if(profile.adeUrl) {
                    const fetchSchedule = async () => {
                        try {
                            const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(profile.adeUrl));
                            const text = await res.text();
                            const parsed = parseICS(text);
                            setAllEvents(parsed.sort((a,b) => a.start - b.start));
                            
                            const d = new Date();
                            const day = d.getDay();
                            
                            let mondayDiff;
                            if (day === 0) mondayDiff = 1; 
                            else if (day === 6) mondayDiff = 2; 
                            else mondayDiff = 1 - day;

                            const monday = new Date();
                            monday.setDate(d.getDate() + mondayDiff);
                            monday.setHours(0,0,0,0);
                            
                            const sunday = new Date(monday);
                            sunday.setDate(monday.getDate() + 7);

                            const weeklyEvents = parsed.filter(e => e.start >= monday && e.start < sunday).sort((a,b)=>a.start-b.start);
                            setEvents(weeklyEvents);
                        } catch(e) { console.log("EDT Error"); }
                    };
                    fetchSchedule();
                }
            }, [profile.adeUrl]);

            // Stats & Level
            const stats = useMemo(() => {
                let p21=0, c21=0, p22=0, c22=0;
                MODULES_CONFIG_S2.forEach(m => {
                    const avg = parseFloat(calcAvg(s2Grades[m.id]));
                    if(!isNaN(avg)) {
                        if(m.coef21>0) { p21+=avg*m.coef21; c21+=m.coef21; }
                        if(m.coef22>0) { p22+=avg*m.coef22; c22+=m.coef22; }
                    }
                });
                const avg21 = c21 ? (p21/c21).toFixed(2) : null;
                const avg22 = c22 ? (p22/c22).toFixed(2) : null;
                const global = (avg21 && avg22) ? ((parseFloat(avg21)+parseFloat(avg22))/2).toFixed(2) : null;
                
                // GAMIFICATION LOGIC
                const tasksDone = Object.values(taskStatus).filter(Boolean).length;
                const avgScore = global ? parseFloat(global) * 100 : 0;
                const xp = Math.round(avgScore + (tasksDone * 50));
                let level = "Novice";
                if(xp > 1500) level = "ConfirmÃ©";
                if(xp > 2500) level = "Expert";
                if(xp > 3500) level = "Major";

                return { avg21, avg22, global, xp, level };
            }, [s2Grades, taskStatus]);

            if (!user) return <div className="h-screen bg-black flex items-center justify-center text-white"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>;

            return (
                <div className="min-h-screen bg-bg text-white pb-24 font-sans selection:bg-primary/30 selection:text-white">
                    {selectedModule && <GradeEditorModal module={selectedModule} grades={s2Grades[selectedModule.id]} onClose={()=>setSelectedModule(null)} onSave={g=>setS2Grades({...s2Grades, [selectedModule.id]: g})} />}

                    {/* FULL AGENDA VIEW (OVERLAY) */}
                    {view === 'FULL_AGENDA' && (
                        <div className="fixed inset-0 z-50 bg-bg overflow-y-auto animate-in slide-in-from-right">
                            <div className="sticky top-0 bg-bg/95 backdrop-blur-md p-4 border-b border-border flex items-center justify-between z-10">
                                <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="calendar" /> Agenda Complet</h2>
                                <button onClick={() => setView('AGENDA')} className="p-2 bg-card rounded-full border border-border text-subtext"><Icon name="x" size={20}/></button>
                            </div>
                            <div className="p-4 pb-10">
                                <AgendaList events={allEvents.filter(e => e.start >= new Date()).slice(0, 50)} profile={profile} /> 
                            </div>
                        </div>
                    )}

                    <header className="p-6 pt-12 flex justify-between items-center bg-gradient-to-b from-primary/10 to-transparent sticky top-0 z-40 backdrop-blur-md">
                        <div><div className="text-xs font-bold text-primary mb-1 uppercase tracking-wider">Espace Ã‰tudiant</div><h1 className="text-3xl font-bold tracking-tight">Bonjour {profile.firstName}</h1></div>
                        <div onClick={()=>setView('SETTINGS')} className="w-10 h-10 rounded-full bg-card border border-border flex items-center justify-center font-bold text-sm cursor-pointer hover:border-white/30 transition-colors">{profile.firstName[0]}</div>
                    </header>

                    <main className="px-4 space-y-8">
                        {announcements.length > 0 && <div className="bg-primary text-white p-4 rounded-2xl flex items-start gap-3 shadow-lg shadow-primary/20 mb-4 animate-in slide-in-from-top-2"><Icon name="info" size={20} className="mt-0.5" /><div><div className="font-bold text-sm uppercase tracking-wide mb-1">Info Admin</div><div className="text-sm opacity-90 leading-relaxed">{announcements[0].text}</div></div></div>}

                        {view === 'HOME' && (
                            <div className="space-y-4 animate-in">
                                <div className="grid grid-cols-2 gap-3 h-40">
                                    <div className="fintech-card p-4 flex flex-col justify-between relative overflow-hidden group cursor-pointer hover:bg-cardHover border border-white/5 transition-colors" onClick={()=>setView('NOTES')}>
                                        <div className="flex justify-between items-start z-10">
                                            <div className="p-2 bg-primary/10 rounded-full text-primary"><Icon name="calculator" size={20}/></div>
                                            <Icon name="arrow-up-right" size={16} className="text-subtext"/>
                                        </div>
                                        <div className="z-10">
                                            <div className="text-3xl font-bold tracking-tighter text-white">{stats.global || '--'}</div>
                                            <div className="text-xs text-subtext font-bold uppercase tracking-wider mt-1">Moyenne S2</div>
                                        </div>
                                        <div className="absolute -bottom-10 -right-10 w-32 h-32 bg-primary/10 rounded-full blur-2xl group-hover:bg-primary/20 transition-all"></div>
                                    </div>
                                    <WeatherWidget />
                                </div>
                                <div className="grid grid-cols-2 gap-3 h-40">
                                    <UpcomingDeadline tasks={TASKS_DATA} taskStatus={taskStatus} />
                                    <PomodoroWidget />
                                </div>
                                
                                <SemesterProgress />
                                <div className="fintech-card p-5 border border-white/5"><h3 className="font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wider text-subtext">Mon Planning</h3>
                                {events.length > 0 ? events.slice(0, 3).map((e, i) => (<div key={i} className="flex gap-4 mb-4 last:mb-0 items-center"><div className="text-xs font-bold text-subtext w-10 text-right">{e.start.getHours()}h{e.start.getMinutes()||'00'}</div><div className="w-1 h-8 rounded-full bg-primary/50"></div><div className="flex-1"><div className="font-bold text-sm text-white truncate">{e.summary}</div><div className="text-xs text-subtext truncate">{e.location}</div></div></div>)) : <div className="text-center text-xs text-subtext py-6 bg-white/5 rounded-xl">Rien Ã  l'horizon ðŸ–ï¸</div>}
                                </div>
                                <Scratchpad note={quickNote} onChange={setQuickNote} />
                            </div>
                        )}

                        {view === 'NOTES' && (
                            <div className="space-y-6 animate-in">
                                <SemesterSelector current={semester} onChange={setSemester} />
                                {semester === 2 ? (
                                    <div className="space-y-6">
                                        <div className="flex gap-2 mb-2">
                                            <button onClick={()=>setVisibleUEs({...visibleUEs, 21: !visibleUEs[21]})} className={`flex-1 py-3 rounded-xl text-xs font-bold border transition-all ${visibleUEs[21]?'bg-primary text-white border-primary shadow-lg shadow-primary/20':'bg-card text-subtext border-border'}`}>UE21 â€¢ Concevoir</button>
                                            <button onClick={()=>setVisibleUEs({...visibleUEs, 22: !visibleUEs[22]})} className={`flex-1 py-3 rounded-xl text-xs font-bold border transition-all ${visibleUEs[22]?'bg-white text-black border-white shadow-lg shadow-white/10':'bg-card text-subtext border-border'}`}>UE22 â€¢ VÃ©rifier</button>
                                        </div>
                                        
                                        <TargetSimulator />

                                        {visibleUEs[21] && <div className="fintech-card p-5 border border-white/5"><div className="flex justify-between mb-6 items-end"><h3 className="font-bold text-primary text-lg">UE21</h3><span className="font-mono font-bold text-2xl text-white">{stats.avg21 || '--'}</span></div><div className="space-y-1">{MODULES_CONFIG_S2.filter(m=>m.coef21>0).map(m=>(<div key={m.id} onClick={()=>setSelectedModule(m)} className="flex justify-between p-3 hover:bg-white/5 rounded-xl cursor-pointer transition-colors group"><div><div className="font-bold text-sm text-white group-hover:text-primary transition-colors">{m.label}</div><div className="text-[10px] text-subtext font-bold uppercase tracking-wider">Coef {m.coef21}</div></div><div className={`font-mono font-bold text-lg ${getGradeColor(calcAvg(s2Grades[m.id]))}`}>{calcAvg(s2Grades[m.id]) || "â€”"}</div></div>))}</div></div>}
                                        {visibleUEs[22] && <div className="fintech-card p-5 border border-white/5"><div className="flex justify-between mb-6 items-end"><h3 className="font-bold text-white text-lg">UE22</h3><span className="font-mono font-bold text-2xl text-white">{stats.avg22 || '--'}</span></div><div className="space-y-1">{MODULES_CONFIG_S2.filter(m=>m.coef22>0).map(m=>(<div key={m.id} onClick={()=>setSelectedModule(m)} className="flex justify-between p-3 hover:bg-white/5 rounded-xl cursor-pointer transition-colors group"><div><div className="font-bold text-sm text-white group-hover:text-white transition-colors">{m.label}</div><div className="text-[10px] text-subtext font-bold uppercase tracking-wider">Coef {m.coef22}</div></div><div className={`font-mono font-bold text-lg ${getGradeColor(calcAvg(s2Grades[m.id]))}`}>{calcAvg(s2Grades[m.id]) || "â€”"}</div></div>))}</div></div>}
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div className="fintech-card p-8 border border-white/5 text-center"><div className="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="archive" size={32} className="text-subtext"/></div><h3 className="font-bold text-xl mb-2">Historique S{semester}</h3><p className="text-sm text-subtext mb-6">Saisissez vos moyennes validÃ©es pour conserver votre historique.</p><div className="space-y-4"><HistoryInput label={`Moyenne UE${semester}1`} value={history[`s${semester}`]?.[`ue${semester}1`]} onChange={v=>setHistory({...history, [`s${semester}`]: {...history[`s${semester}`], [`ue${semester}1`]: v}})} /><HistoryInput label={`Moyenne UE${semester}2`} value={history[`s${semester}`]?.[`ue${semester}2`]} onChange={v=>setHistory({...history, [`s${semester}`]: {...history[`s${semester}`], [`ue${semester}2`]: v}})} /></div></div>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'AGENDA' && (
                            <div className="space-y-8 animate-in">
                                <div><h2 className="text-3xl font-bold mb-6 tracking-tight">Planning</h2><AgendaList events={allEvents} profile={profile} onExpand={() => setView('FULL_AGENDA')} /></div>
                                <div><h2 className="text-3xl font-bold mb-6 tracking-tight">Deadlines</h2><div className="fintech-card p-2 border border-white/5"><QCMList tasks={TASKS_DATA} taskStatus={taskStatus} onToggle={(id)=>{const nt={...taskStatus,[id]:!taskStatus[id]}; setTaskStatus(nt);}} /></div></div>
                            </div>
                        )}

                        {view === 'LIFE' && (
                            <div className="space-y-8 animate-in">
                                <div><h2 className="text-3xl font-bold mb-6 tracking-tight">Campus</h2><div className="grid grid-cols-2 gap-4"><CrousWidget /><TrafficWidget /></div></div>
                                <div><h2 className="text-3xl font-bold mb-6 tracking-tight">Liens</h2><div className="grid grid-cols-1 gap-3">{USEFUL_LINKS.map((link, i) => (<a key={i} href={link.url} target="_blank" className="flex items-center gap-4 fintech-card p-4 border border-white/5 active:scale-98 transition-transform hover:bg-cardHover"><div className={`w-12 h-12 rounded-full ${link.color} flex items-center justify-center text-white shadow-lg`}><Icon name={link.icon} size={20} /></div><span className="font-bold text-base">{link.name}</span><Icon name="chevron-right" size={20} className="ml-auto text-subtext/50"/></a>))}</div></div>
                            </div>
                        )}

                        {view === 'SETTINGS' && (
                            <div className="space-y-6 animate-in">
                                <h2 className="text-3xl font-bold tracking-tight">Profil</h2>
                                <div className="bg-gradient-to-br from-primary to-blue-700 p-8 rounded-3xl shadow-2xl shadow-primary/20 flex flex-col items-center text-center relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-8 opacity-20"><Icon name="award" size={120}/></div>
                                    <div className="relative z-10">
                                        <div className="text-xs uppercase font-bold text-white/70 mb-2 tracking-widest">Niveau Actuel</div>
                                        <div className="text-4xl font-bold text-white mb-1">{stats.level}</div>
                                        <div className="text-sm font-mono text-white/80 bg-white/20 px-3 py-1 rounded-full inline-block">{stats.xp} XP</div>
                                    </div>
                                </div>

                                <div className="fintech-card p-6 border border-white/5 space-y-6">
                                    <div><label className="text-xs text-subtext font-bold uppercase tracking-wider block mb-2">PrÃ©nom</label><input value={profile.firstName} onChange={e=>setProfile({...profile, firstName:e.target.value})} className="w-full bg-black/50 border border-white/10 rounded-xl p-4 text-base focus:border-primary outline-none text-white font-medium"/></div>
                                    <div><label className="text-xs text-subtext font-bold uppercase tracking-wider block mb-2">Lien ADE (iCal)</label><input value={profile.adeUrl} onChange={e=>setProfile({...profile, adeUrl:e.target.value})} className="w-full bg-black/50 border border-white/10 rounded-xl p-4 text-xs font-mono text-subtext focus:border-primary outline-none break-all"/></div>
                                </div>
                                <button onClick={()=>{localStorage.clear();window.location.reload()}} className="w-full py-4 text-danger font-bold text-sm bg-danger/10 rounded-xl border border-danger/20 active:scale-95 transition-transform hover:bg-danger/20">RÃ©initialiser l'application</button>
                            </div>
                        )}
                    </main>
                    <BottomNav active={view} setView={setView} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
