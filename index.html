<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEII OS v4.5 - Agenda Unifié</title>
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, onSnapshot, collection, getDoc };
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: '#000000',
                        card: '#1c1c1e',
                        cardHover: '#2c2c2e',
                        border: '#3a3a3c',
                        primary: '#0A84FF',
                        success: '#30D158',
                        danger: '#FF453A',
                        warning: '#FF9F0A',
                        text: '#FFFFFF',
                        subtext: '#8E8E93',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['"SF Mono"', '"JetBrains Mono"', 'monospace'],
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #000; color: #fff; -webkit-font-smoothing: antialiased; }
        .glass { background: rgba(28, 28, 30, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-modal { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .widget-hover:hover { transform: scale(1.02); transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes pulse-subtle { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse-subtle { animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIG ---
        const LINKS = {
            ADE: "https://edt.univ-lyon1.fr/direct/index.jsp?projectId=1&ShowPianoWeeks=true&resources=13655&displayConfName=_DirectPlanning_IUT-GEII&days=0,1,2,3,4&weeks=&from=edt",
            MAIL: "https://mail.univ-lyon1.fr/owa/auth/logon.aspx?url=https%3a%2f%2fmail.univ-lyon1.fr%2fowa%2f&reason=0",
            DOCS: "https://wwwgeii.univ-lyon1.fr/depot_certif/view_user_docs.php",
            MOODLE: "https://moodle.univ-lyon1.fr/",
            MIRE: "https://wwwgeii.univ-lyon1.fr/mire_geii.php"
        };

        const MODULES_CONFIG = [
            { id: 'R2.01', short: 'AN2', label: 'Analyse', coef21: 1.1, coef22: 0, category: 'Fonda' },
            { id: 'R2.02', short: 'CC2', label: 'Culture Com', coef21: 1.1, coef22: 0, category: 'Trans' },
            { id: 'R2.03', short: 'VE2', label: 'Vie Entr.', coef21: 0.8, coef22: 0, category: 'Trans' },
            { id: 'R2.04', short: 'OML2', label: 'Outils Maths', coef21: 2.6, coef22: 0, category: 'Fonda' },
            { id: 'R2.05', short: 'PPP2', label: 'Projet Pro', coef21: 0.8, coef22: 0.2, category: 'Trans' },
            { id: 'R2.06', short: 'AUTO2', label: 'Automatisme', coef21: 0, coef22: 2.6, category: 'Tech' },
            { id: 'R2.07', short: 'INFO2', label: 'Info Indus', coef21: 0, coef22: 2.6, category: 'Tech' },
            { id: 'R2.08', short: 'ELEN2', label: 'Élec/Énergie', coef21: 1.3, coef22: 1.3, category: 'Tech' },
            { id: 'R2.09', short: 'ENER2', label: 'Énergie', coef21: 1.3, coef22: 1.3, category: 'Tech' },
            { id: 'R2.10', short: 'PApp2', label: 'Physique App', coef21: 0, coef22: 1.0, category: 'Fonda' },
            { id: 'S2.1', short: 'SAÉ 2.1', label: 'CAPA', coef21: 2.5, coef22: 2.5, category: 'SAÉ' },
            { id: 'S2.2', short: 'SAÉ 2.2', label: 'Robot', coef21: 2.5, coef22: 2.5, category: 'SAÉ' },
            { id: 'PF2', short: 'PORTF', label: 'Portfolio S2', coef21: 1.0, coef22: 1.0, category: 'SAÉ' },
        ];

        const TASKS_DATA = [
            { module: 'R2.09', title: 'QCM_TD1', end: '2026-02-13', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD2', end: '2026-03-04', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD3', end: '2026-03-06', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD4', end: '2026-03-13', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD6', end: '2026-03-27', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD8', end: '2026-04-24', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD9', end: '2026-04-30', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD11', end: '2026-05-08', type: 'QCM' },
            { module: 'R2.09', title: 'QCM_TD12', end: '2026-05-21', type: 'QCM' },
            { module: 'R2.10', title: 'QCM1_Séance 1', end: '2026-02-06', type: 'QCM' },
            { module: 'R2.10', title: 'QCM2_Séance 2', end: '2026-02-13', type: 'QCM' },
            { module: 'R2.10', title: 'QCM3 - Devoir', end: '2026-02-27', type: 'DEVOIR' },
            { module: 'R2.10', title: 'QCM4', end: '2026-03-06', type: 'QCM' },
            { module: 'R2.10', title: 'QCM5', end: '2026-03-13', type: 'QCM' },
            { module: 'R2.10', title: 'QCM6', end: '2026-03-20', type: 'QCM' },
            { module: 'R2.10', title: 'QCM7', end: '2026-03-28', type: 'QCM' },
            { module: 'R2.10', title: 'QCM8', end: '2026-04-04', type: 'QCM' },
            { module: 'R2.10', title: 'QCM10', end: '2026-04-18', type: 'QCM' },
            { module: 'R2.10', title: 'QCM11', end: '2026-05-09', type: 'QCM' },
            { module: 'R2.10', title: 'QCM12', end: '2026-05-16', type: 'QCM' },
            { module: 'R2.10', title: 'QCM13', end: '2026-05-23', type: 'QCM' },
            { module: 'R2.10', title: 'QCM14', end: '2026-05-30', type: 'QCM' },
        ];
        
        const startDate = new Date('2026-02-02');
        for(let i=0; i<10; i++) {
            let d1 = new Date(startDate); d1.setDate(startDate.getDate() + (i*7));
            let d2 = new Date(startDate); d2.setDate(startDate.getDate() + (i*7) + 3);
            TASKS_DATA.push({ module: 'R2.04', title: `QCM Hebdo ${i+1}.1`, end: d1.toISOString().split('T')[0], type: 'MATHS' });
            TASKS_DATA.push({ module: 'R2.04', title: `QCM Hebdo ${i+1}.2`, end: d2.toISOString().split('T')[0], type: 'MATHS' });
        }

        // --- HELPERS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const calculateSubjectAverage = (grades) => {
            if (!grades || grades.length === 0) return null;
            let totalPoints = 0, totalCoef = 0;
            grades.forEach(g => { totalPoints += parseFloat(g.value) * parseFloat(g.coef); totalCoef += parseFloat(g.coef); });
            return totalCoef === 0 ? 0 : (totalPoints / totalCoef).toFixed(2);
        };

        const getGradeColor = (val) => {
            if (val === null || val === "—") return "text-subtext";
            const v = parseFloat(val);
            if (v < 8) return "text-danger"; if (v < 10) return "text-warning"; if (v < 14) return "text-primary"; return "text-success";
        };

        const getModuleName = (id) => {
            const mod = MODULES_CONFIG.find(m => m.id === id);
            return mod ? mod.label : id;
        };

        const parseICS = (icsData) => {
            const events = [];
            const lines = icsData.split(/\r\n|\n|\r/);
            let inEvent = false;
            let event = {};
            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                dateStr = dateStr.trim();
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6)) - 1;
                const day = parseInt(dateStr.substring(6, 8));
                let hour = 0, minute = 0;
                if (dateStr.includes('T')) {
                    const timePart = dateStr.split('T')[1];
                    hour = parseInt(timePart.substring(0, 2));
                    minute = parseInt(timePart.substring(2, 4));
                }
                return new Date(year, month, day, hour, minute);
            };
            for (let line of lines) {
                if (line.startsWith('BEGIN:VEVENT')) { inEvent = true; event = {}; } 
                else if (line.startsWith('END:VEVENT')) { inEvent = false; if (event.start && event.summary) events.push(event); } 
                else if (inEvent) {
                    if (line.startsWith('DTSTART')) { const parts = line.split(':'); if(parts.length > 1) event.start = parseDate(parts[1]); }
                    else if (line.startsWith('DTEND')) { const parts = line.split(':'); if(parts.length > 1) event.end = parseDate(parts[1]); }
                    else if (line.startsWith('SUMMARY')) { event.summary = line.split(':')[1]?.replace(/\\,/g, ',') || 'Cours'; }
                    else if (line.startsWith('LOCATION')) { event.location = line.split(':')[1]?.replace(/\\,/g, ',') || ''; }
                }
            }
            return events;
        };

        // --- COMPONENTS ---

        const GradeEditorModal = ({ module, grades, onClose, onSave }) => {
            const [localGrades, setLocalGrades] = useState(grades || []);
            const [newNote, setNewNote] = useState('');
            const [newCoef, setNewCoef] = useState('1');
            const [newName, setNewName] = useState('');
            const [simulatedAvg, setSimulatedAvg] = useState(null);

            const handleAdd = () => {
                if (!newNote || !newCoef) return;
                const updated = [...localGrades, { id: Date.now(), value: parseFloat(newNote), coef: parseFloat(newCoef), name: newName || `Note ${localGrades.length + 1}` }];
                setLocalGrades(updated); setNewNote(''); setNewName(''); onSave(updated);
            };
            const handleDelete = (id) => { const updated = localGrades.filter(g => g.id !== id); setLocalGrades(updated); onSave(updated); };
            const currentAvg = calculateSubjectAverage(localGrades) || "—";
            
            useEffect(() => {
                if (newNote && newCoef) {
                    const temp = [...localGrades, { value: parseFloat(newNote), coef: parseFloat(newCoef) }];
                    setSimulatedAvg(calculateSubjectAverage(temp));
                } else setSimulatedAvg(null);
            }, [newNote, newCoef, localGrades]);

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center glass-modal p-0 sm:p-4 animate-in fade-in duration-200">
                    <div className="bg-[#1c1c1e] w-full max-w-lg sm:rounded-2xl rounded-t-2xl border border-white/10 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-white/10 flex justify-between items-center bg-[#2c2c2e]">
                            <div><h2 className="text-xl font-bold text-white flex gap-2">{module.short} <span className={`text-2xl font-mono ${getGradeColor(currentAvg)}`}>{currentAvg}</span></h2><p className="text-xs text-subtext">{module.label}</p></div>
                            <button onClick={onClose} className="bg-white/10 p-2 rounded-full hover:bg-white/20"><Icon name="x" size={20}/></button>
                        </div>
                        <div className="p-4 overflow-y-auto flex-1 space-y-6">
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-subtext uppercase tracking-wider">Relevé</label>
                                {localGrades.length === 0 ? <div className="text-center py-6 text-subtext italic">Aucune note.</div> : localGrades.map((g) => (
                                    <div key={g.id} className="flex justify-between items-center bg-black/40 p-3 rounded-xl border border-white/5">
                                        <div><div className="font-medium text-sm text-white">{g.name}</div><div className="text-xs text-subtext">Coef: {g.coef}</div></div>
                                        <div className="flex items-center gap-3"><span className={`font-mono font-bold ${getGradeColor(g.value)}`}>{g.value}</span><button onClick={() => handleDelete(g.id)} className="text-danger opacity-50 hover:opacity-100"><Icon name="trash-2" size={16}/></button></div>
                                    </div>
                                ))}
                            </div>
                            <div className="bg-white/5 p-4 rounded-xl border border-white/10 space-y-3">
                                <label className="text-xs font-bold text-primary uppercase flex gap-2"><Icon name="plus-circle" size={12}/> Ajouter / Simuler</label>
                                <div className="grid grid-cols-3 gap-2">
                                    <input type="text" placeholder="Nom (DS1)" value={newName} onChange={e=>setNewName(e.target.value)} className="col-span-3 bg-black border border-white/20 rounded-lg p-2 text-sm focus:border-primary outline-none" />
                                    <div className="col-span-2 relative"><input type="number" placeholder="Note" value={newNote} onChange={e=>setNewNote(e.target.value)} className="w-full bg-black border border-white/20 rounded-lg p-2 text-sm focus:border-primary outline-none" /><span className="absolute right-3 top-2 text-subtext text-xs">/20</span></div>
                                    <input type="number" placeholder="Coef" value={newCoef} onChange={e=>setNewCoef(e.target.value)} className="bg-black border border-white/20 rounded-lg p-2 text-sm focus:border-primary outline-none" />
                                </div>
                                <div className="flex justify-between items-center mt-2"><div className="text-xs text-subtext">{simulatedAvg && <span className="text-warning">Simulé : {simulatedAvg}</span>}</div><button onClick={handleAdd} className="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Ajouter</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TimetableWidget = ({ fullWidth }) => {
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [displayMode, setDisplayMode] = useState('TODAY');

            useEffect(() => {
                const fetchSchedule = async () => {
                    try {
                        const apiRes = await fetch('/api/edt');
                        let text = "";
                        
                        if (apiRes.ok) {
                            text = await apiRes.text();
                        } else {
                            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent("https://edt.univ-lyon1.fr/jsp/custom/modules/plannings/anonymous_cal.jsp?resources=13655&projectId=1&calType=ical&firstDate=2025-08-18&lastDate=2026-08-01");
                            const res = await fetch(proxyUrl);
                            if (!res.ok) throw new Error("Network error");
                            text = await res.text();
                        }

                        let parsedEvents = parseICS(text);
                        processEvents(parsedEvents);
                        setLoading(false);
                    } catch (err) {
                        const today = new Date();
                        const y = today.getFullYear(), m = today.getMonth(), d = today.getDate();
                        const demo = [
                            { start: new Date(y, m, d, 8, 0), end: new Date(y, m, d, 10, 0), summary: 'R2.06 Automatisme', location: 'Salle TP3' },
                            { start: new Date(y, m, d, 10, 15), end: new Date(y, m, d, 12, 15), summary: 'R2.07 Informatique', location: 'Salle I12' },
                            { start: new Date(y, m, d+1, 9, 0), end: new Date(y, m, d+1, 11, 0), summary: 'Anglais', location: 'Labo Langues' },
                        ];
                        processEvents(demo);
                        setLoading(false);
                    }
                };
                fetchSchedule();
            }, []);

            const processEvents = (allEvents) => {
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
                const todayEvents = allEvents.filter(e => e.start >= todayStart && e.start < todayEnd).sort((a, b) => a.start - b.start);
                
                if (todayEvents.length > 0) { setEvents(todayEvents); setDisplayMode('TODAY'); }
                else {
                    const upcoming = allEvents.filter(e => e.start >= todayEnd).sort((a, b) => a.start - b.start).slice(0, 5);
                    setEvents(upcoming); setDisplayMode('UPCOMING');
                }
            };

            return (
                <div className={`glass p-4 rounded-2xl flex flex-col ${fullWidth ? 'min-h-[220px]' : 'h-full min-h-[180px]'}`}>
                    <div className="flex justify-between items-start mb-3">
                        <div className="text-xs text-subtext font-bold uppercase tracking-wider">{displayMode === 'TODAY' ? "Aujourd'hui" : "Prochains Cours"}</div>
                        <div className="text-xs font-bold text-primary">{displayMode === 'TODAY' ? new Date().toLocaleDateString('fr-FR', {weekday: 'short'}) : 'À venir'}</div>
                    </div>
                    {loading ? <div className="flex-1 flex items-center justify-center"><div className="w-5 h-5 border-2 border-white/20 border-t-primary rounded-full animate-spin"></div></div> : 
                    events.length > 0 ? (
                        <div className={`space-y-2 overflow-y-auto hide-scrollbar ${fullWidth ? 'max-h-[200px]' : 'max-h-[120px]'}`}>
                            {events.map((c, i) => (
                                <div key={i} className="flex gap-3 items-center text-sm">
                                    <div className="flex flex-col items-center min-w-[35px]">
                                        <span className="font-mono text-white text-xs whitespace-nowrap">{c.start.getHours()}h{c.start.getMinutes().toString().padStart(2, '0')}</span>
                                        {displayMode === 'UPCOMING' && <span className="text-[9px] text-subtext">{c.start.toLocaleDateString('fr-FR', {weekday: 'short'})}</span>}
                                    </div>
                                    <div className="flex-1 bg-white/5 rounded px-2 py-1 border-l-2 border-primary overflow-hidden">
                                        <div className="font-medium text-white truncate">{c.summary || 'Cours'}</div>
                                        <div className="text-[10px] text-subtext truncate">{c.location || 'Salle inconnue'}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : <div className="flex-1 flex flex-col items-center justify-center text-xs text-subtext"><Icon name="coffee" size={24} className="mb-2 opacity-50"/>Aucun cours</div>}
                </div>
            );
        };

        const TasksList = ({ tasks, taskStatus, onToggle }) => {
            const sortedTasks = [...tasks].sort((a,b) => new Date(a.end) - new Date(b.end));
            const now = new Date();
            return (
                <div className="space-y-2 pb-20">
                    {sortedTasks.map((task, i) => {
                        const uid = task.title + task.module;
                        const isDone = taskStatus[uid];
                        const deadline = new Date(task.end);
                        const diffDays = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                        let color = "text-subtext", text = `${diffDays}j`;
                        if (isDone) { text = "Fait"; color = "text-success"; }
                        else if (diffDays < 0) { text = "Retard"; color = "text-danger"; }
                        else if (diffDays <= 3) { text = `J-${diffDays}`; color = "text-danger font-bold"; }
                        else if (diffDays <= 7) { text = `J-${diffDays}`; color = "text-warning"; }

                        return (
                            <div key={i} onClick={() => onToggle(uid)} className={`flex items-center justify-between p-4 rounded-xl border cursor-pointer transition-all ${isDone ? 'bg-black/30 border-white/5 opacity-60' : 'bg-[#1c1c1e] border-white/10 hover:border-white/20'}`}>
                                <div className="flex items-center gap-4">
                                    <div className={`w-6 h-6 rounded-full border flex items-center justify-center ${isDone ? 'bg-success border-success' : 'border-subtext'}`}>{isDone && <Icon name="check" size={14} className="text-black"/>}</div>
                                    <div>
                                        <div className={`font-bold text-sm ${isDone ? 'line-through text-subtext' : 'text-white'}`}>{task.title}</div>
                                        <div className="text-xs text-subtext flex gap-2">
                                            <span className={`px-1.5 rounded text-[10px] ${isDone ? 'bg-white/5' : 'bg-primary/20 text-primary'}`}>{getModuleName(task.module)}</span>
                                            <span>{new Date(task.end).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div className={`text-xs font-mono text-right ${color}`}>{text}</div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [gradesMap, setGradesMap] = useState({});
            const [absences, setAbsences] = useState({});
            const [taskStatus, setTaskStatus] = useState({});
            const [selectedModule, setSelectedModule] = useState(null);
            const [stats, setStats] = useState({ avg21: "—", avg22: "—", global: "—" });
            const [currentView, setCurrentView] = useState('DASHBOARD');
            
            const dbRef = useRef(null);
            const appIdRef = useRef(typeof __app_id !== 'undefined' ? __app_id : 'default-fintech-app');

            useEffect(() => {
                const init = async () => {
                    const timeout = setTimeout(() => {
                        if (!user) {
                            const saved = localStorage.getItem('geii_fintech_data');
                            if (saved) { const p = JSON.parse(saved); setGradesMap(p.grades||{}); setAbsences(p.absences||{}); setTaskStatus(p.tasks||{}); }
                            setUser({ uid: 'OFFLINE' });
                        }
                    }, 3000);

                    if (typeof __firebase_config === 'undefined' || !__firebase_config) {
                        clearTimeout(timeout);
                        const saved = localStorage.getItem('geii_fintech_data');
                        if (saved) { const p = JSON.parse(saved); setGradesMap(p.grades||{}); setAbsences(p.absences||{}); setTaskStatus(p.tasks||{}); }
                        setUser({ uid: 'LOCAL' });
                        return;
                    }

                    let attempts = 0;
                    while (!window.firebaseModules && attempts < 20) { await new Promise(r => setTimeout(r, 100)); attempts++; }
                    if (!window.firebaseModules) return;

                    clearTimeout(timeout);
                    const { initializeApp, getAuth, signInAnonymously, getFirestore, doc, onSnapshot, signInWithCustomToken } = window.firebaseModules;
                    
                    try {
                        const app = initializeApp(JSON.parse(__firebase_config));
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        dbRef.current = db;
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                        
                        onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            if (u) {
                                onSnapshot(doc(db, 'artifacts', appIdRef.current, 'users', u.uid, 'fintech_data'), (snap) => {
                                    if (snap.exists()) { setGradesMap(snap.data().grades||{}); setAbsences(snap.data().absences||{}); setTaskStatus(snap.data().tasks||{}); }
                                });
                            }
                        });
                    } catch (e) { setUser({ uid: 'ERROR' }); }
                };
                init();
            }, []);

            const saveData = (g, a, t) => {
                const payload = { grades: g||gradesMap, absences: a||absences, tasks: t||taskStatus };
                if (!dbRef.current) localStorage.setItem('geii_fintech_data', JSON.stringify(payload));
                else if (user && user.uid !== 'LOCAL' && user.uid !== 'OFFLINE') {
                    const { doc, setDoc } = window.firebaseModules;
                    setDoc(doc(dbRef.current, 'artifacts', appIdRef.current, 'users', user.uid, 'fintech_data'), payload, { merge: true });
                }
            };

            useEffect(() => {
                const calcUE = (k) => {
                    let pts=0, coef=0;
                    MODULES_CONFIG.forEach(m => {
                        const c = m[k];
                        if (c>0) {
                            const avg = calculateSubjectAverage(gradesMap[m.id]);
                            if (avg) { pts += parseFloat(avg)*c; coef += c; }
                        }
                    });
                    return coef===0 ? "—" : (pts/coef).toFixed(2);
                };
                const avg21 = calcUE('coef21'), avg22 = calcUE('coef22');
                let glob = "—";
                if(avg21!=="—" && avg22!=="—") glob = ((parseFloat(avg21)+parseFloat(avg22))/2).toFixed(2);
                else if(avg21!=="—") glob = avg21;
                else if(avg22!=="—") glob = avg22;
                setStats({ avg21, avg22, global: glob });
            }, [gradesMap]);

            if (!user) return <div className="h-screen bg-black flex flex-col items-center justify-center text-white font-mono"><div className="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>BOOTING GEII OS...</div>;

            return (
                <div className="min-h-screen bg-black pb-24 selection:bg-primary selection:text-white font-sans">
                    {selectedModule && <GradeEditorModal module={selectedModule} grades={gradesMap[selectedModule.id]} onClose={()=>setSelectedModule(null)} onSave={g=>{const nm={...gradesMap,[selectedModule.id]:g};setGradesMap(nm);saveData(nm,undefined,undefined);}} />}

                    <header className="sticky top-0 z-40 bg-black/80 backdrop-blur-md border-b border-white/10">
                        <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-primary to-blue-900 flex items-center justify-center shadow-lg shadow-primary/20"><Icon name="zap" size={16} className="text-white"/></div>
                                <span className="font-bold text-lg tracking-tight">GEII<span className="text-subtext">OS</span></span>
                            </div>
                            <div className="flex bg-[#1c1c1e] p-1 rounded-lg border border-white/10">
                                <button onClick={()=>setCurrentView('DASHBOARD')} className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${currentView==='DASHBOARD'?'bg-white/10 text-white shadow':'text-subtext hover:text-white'}`}>Notes</button>
                                <button onClick={()=>setCurrentView('AGENDA')} className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${currentView==='AGENDA'?'bg-white/10 text-white shadow':'text-subtext hover:text-white'}`}>Agenda</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto p-4 space-y-6">
                        {currentView === 'DASHBOARD' && (
                            <div className="animate-in fade-in duration-300 space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 h-auto md:h-48">
                                    <div className="col-span-2 md:col-span-2 glass p-6 rounded-3xl flex flex-col justify-between relative overflow-hidden group">
                                        <div className="absolute -right-10 -top-10 w-40 h-40 bg-primary/20 blur-3xl rounded-full group-hover:bg-primary/30 transition-all duration-500 animate-pulse-subtle"></div>
                                        <div><h2 className="text-sm font-bold text-subtext uppercase tracking-wider mb-1">Moyenne Générale</h2><div className="text-5xl font-mono font-bold tracking-tighter text-white">{stats.global}<span className="text-xl text-subtext opacity-50">/20</span></div></div>
                                        <div className="flex gap-4 mt-4">
                                            <div className="bg-white/5 px-3 py-1.5 rounded-lg border border-white/5"><div className="text-[10px] text-subtext">UE21</div><div className={`font-bold text-sm ${getGradeColor(stats.avg21)}`}>{stats.avg21}</div></div>
                                            <div className="bg-white/5 px-3 py-1.5 rounded-lg border border-white/5"><div className="text-[10px] text-subtext">UE22</div><div className={`font-bold text-sm ${getGradeColor(stats.avg22)}`}>{stats.avg22}</div></div>
                                        </div>
                                    </div>
                                    <div className="col-span-1 widget-hover cursor-pointer"><TimetableWidget /></div>
                                    <div className="col-span-1 widget-hover cursor-pointer">
                                        <div className="glass p-4 rounded-2xl h-full flex flex-col justify-center items-center text-center">
                                            <div className="text-3xl font-bold mb-1">{Object.values(taskStatus).filter(Boolean).length}</div>
                                            <div className="text-[10px] text-subtext uppercase">Tâches Finies</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-3 overflow-x-auto hide-scrollbar pb-2">
                                    {[{ name: 'Moodle', url: LINKS.MOODLE, color: 'bg-orange-500', icon: 'graduation-cap' },{ name: 'Mire GEII', url: LINKS.MIRE, color: 'bg-emerald-500', icon: 'file-text' },{ name: 'ADE Planning', url: LINKS.ADE, color: 'bg-indigo-500', icon: 'calendar' },{ name: 'Mail Univ', url: LINKS.MAIL, color: 'bg-sky-500', icon: 'mail' },{ name: 'Dépôt Justif', url: LINKS.DOCS, color: 'bg-purple-500', icon: 'paperclip' }].map((link, i) => (
                                        <a key={i} href={link.url} target="_blank" className="flex items-center gap-2 pl-2 pr-4 py-2 bg-[#1c1c1e] border border-white/5 rounded-full whitespace-nowrap hover:bg-[#2c2c2e] transition-colors"><div className={`w-6 h-6 rounded-full ${link.color} flex items-center justify-center text-white`}><Icon name={link.icon} size={12} /></div><span className="text-xs font-bold">{link.name}</span></a>
                                    ))}
                                </div>

                                <div>
                                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="folder-open" size={20} className="text-subtext"/>Portfolio S2</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {MODULES_CONFIG.map(module => {
                                            const avg = calculateSubjectAverage(gradesMap[module.id]);
                                            const absCount = absences[module.id] || 0;
                                            const noteCount = gradesMap[module.id]?.length || 0;
                                            return (
                                                <div key={module.id} className="bg-[#1c1c1e] border border-white/5 p-4 rounded-2xl group hover:border-white/20 transition-all">
                                                    <div className="flex justify-between items-start mb-4 cursor-pointer" onClick={() => setSelectedModule(module)}>
                                                        <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-xs font-bold text-subtext group-hover:text-white group-hover:bg-primary/20 transition-colors">{module.short.substring(0,2)}</div><div><div className="font-bold text-sm text-white leading-tight">{module.short}</div><div className="text-[10px] text-subtext">{module.category}</div></div></div>
                                                        <div className={`font-mono font-bold text-xl ${getGradeColor(avg)}`}>{avg || <span className="text-subtext opacity-30">—</span>}</div>
                                                    </div>
                                                    <div className="flex justify-between items-center pt-3 border-t border-white/5">
                                                        <div className="flex gap-2 text-[10px] text-subtext font-mono"><span>{noteCount} note{noteCount > 1 ? 's' : ''}</span></div>
                                                        <div className="flex items-center gap-1 bg-black rounded-lg p-1 border border-white/5">
                                                            <button onClick={(e) => { e.stopPropagation(); const na={...absences,[module.id]:Math.max(0,(absences[module.id]||0)-1)}; setAbsences(na); saveData(undefined,na,undefined); }} className="w-5 h-5 flex items-center justify-center hover:bg-white/10 rounded text-subtext hover:text-white">-</button>
                                                            <span className={`text-xs font-mono font-bold w-4 text-center ${absCount > 0 ? 'text-danger' : 'text-subtext'}`}>{absCount}</span>
                                                            <button onClick={(e) => { e.stopPropagation(); const na={...absences,[module.id]:(absences[module.id]||0)+1}; setAbsences(na); saveData(undefined,na,undefined); }} className="w-5 h-5 flex items-center justify-center hover:bg-white/10 rounded text-subtext hover:text-white">+</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                        {currentView === 'AGENDA' && (
                            <div className="animate-in fade-in duration-300 space-y-8">
                                <section>
                                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="calendar" size={20} className="text-primary"/>Mon Planning</h2>
                                    <TimetableWidget fullWidth={true} />
                                </section>
                                <section>
                                    <div className="mb-4">
                                        <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="list-todo" size={20} className="text-warning"/>Deadlines QCM</h2>
                                        <p className="text-subtext text-xs mt-1 ml-7">Suivi des travaux Énergie, Physique & Maths</p>
                                    </div>
                                    <TasksList tasks={TASKS_DATA} taskStatus={taskStatus} onToggle={id=>{ const nt={...taskStatus,[id]:!taskStatus[id]}; setTaskStatus(nt); saveData(undefined,undefined,nt); }} />
                                </section>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
