<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GEII OS Ultimate</title>
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signOut, getFirestore, doc, setDoc, onSnapshot, getDoc };
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: '#050505',
                        card: '#121212',
                        cardHover: '#1E1E1E',
                        primary: '#3b82f6',
                        accent: '#8b5cf6',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        text: '#FFFFFF',
                        subtext: '#A1A1AA',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #fff; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 30, 30, 0.4); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-modal { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURATION ---
        const DEFAULT_ADE = "https://edt.univ-lyon1.fr/jsp/custom/modules/plannings/anonymous_cal.jsp?resources=13655&projectId=1&calType=ical&firstDate=2025-08-18&lastDate=2026-08-01";
        
        const MODULES_CONFIG_S2 = [
            { id: 'R2.01', short: 'AN2', label: 'Analyse', coef21: 1.1, coef22: 0, cat: 'Fonda' },
            { id: 'R2.02', short: 'CC2', label: 'Culture Com', coef21: 1.1, coef22: 0, cat: 'Trans' },
            { id: 'R2.03', short: 'VE2', label: 'Vie Entr.', coef21: 0.8, coef22: 0, cat: 'Trans' },
            { id: 'R2.04', short: 'OML2', label: 'Outils Maths', coef21: 2.6, coef22: 0, cat: 'Fonda' },
            { id: 'R2.05', short: 'PPP2', label: 'Projet Pro', coef21: 0.8, coef22: 0.2, cat: 'Trans' },
            { id: 'R2.06', short: 'AUTO2', label: 'Automatisme', coef21: 0, coef22: 2.6, cat: 'Tech' },
            { id: 'R2.07', short: 'INFO2', label: 'Info Indus', coef21: 0, coef22: 2.6, cat: 'Tech' },
            { id: 'R2.08', short: 'ELEN2', label: '√âlec/√ânergie', coef21: 1.3, coef22: 1.3, cat: 'Tech' },
            { id: 'R2.09', short: 'ENER2', label: '√ânergie', coef21: 1.3, coef22: 1.3, cat: 'Tech' },
            { id: 'R2.10', short: 'PApp2', label: 'Physique App', coef21: 0, coef22: 1.0, cat: 'Fonda' },
            { id: 'S2.1', short: 'SA√â 2.1', label: 'SA√â CAPA', coef21: 2.5, coef22: 2.5, cat: 'SA√â' },
            { id: 'S2.2', short: 'SA√â 2.2', label: 'SA√â Robot', coef21: 2.5, coef22: 2.5, cat: 'SA√â' },
            { id: 'PF2', short: 'PORTF', label: 'Portfolio S2', coef21: 1.0, coef22: 1.0, cat: 'SA√â' },
        ];

        // --- HELPERS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const calcAvg = (grades) => {
            if (!grades || grades.length === 0) return null;
            let pts = 0, coef = 0;
            grades.forEach(g => { pts += parseFloat(g.value) * parseFloat(g.coef); coef += parseFloat(g.coef); });
            return coef === 0 ? 0 : (pts / coef).toFixed(2);
        };

        const getGradeColor = (val) => {
            if (val === null || val === "‚Äî") return "text-subtext";
            const v = parseFloat(val);
            return v < 10 ? "text-danger" : v < 12 ? "text-warning" : "text-success";
        };

        const parseICS = (icsData) => {
            const events = [];
            const lines = icsData.split(/\r\n|\n|\r/);
            let inEvent = false, event = {};
            
            const parseDate = (d) => {
                if(!d) return null;
                const y = parseInt(d.substring(0,4)), m = parseInt(d.substring(4,6))-1, day = parseInt(d.substring(6,8));
                let h=0, min=0;
                if(d.includes('T')) { h = parseInt(d.split('T')[1].substring(0,2)); min = parseInt(d.split('T')[1].substring(2,4)); }
                return new Date(y, m, day, h, min);
            };

            for(let l of lines) {
                if(l.startsWith('BEGIN:VEVENT')) { inEvent=true; event={}; }
                else if(l.startsWith('END:VEVENT')) { inEvent=false; if(event.start) events.push(event); }
                else if(inEvent) {
                    if(l.startsWith('DTSTART')) event.start = parseDate(l.split(':')[1]);
                    else if(l.startsWith('DTEND')) event.end = parseDate(l.split(':')[1]);
                    else if(l.startsWith('SUMMARY')) event.summary = l.split(':')[1]?.replace(/\\,/g, ',') || 'Cours';
                    else if(l.startsWith('LOCATION')) event.location = l.split(':')[1]?.replace(/\\,/g, ',') || '';
                }
            }
            return events;
        };

        // --- COMPONENTS ---

        // 1. BOTTOM NAVIGATION
        const BottomNav = ({ active, setView }) => (
            <div className="fixed bottom-0 w-full bg-[#050505]/90 backdrop-blur-xl border-t border-white/10 pb-safe pt-2 px-2 flex justify-between z-50">
                {[
                    { id: 'HOME', icon: 'layout-grid', label: 'Accueil' },
                    { id: 'AGENDA', icon: 'calendar', label: 'Agenda' },
                    { id: 'NOTES', icon: 'graduation-cap', label: 'Notes' },
                    { id: 'LIFE', icon: 'coffee', label: 'Vie √âtud.' },
                    { id: 'SETTINGS', icon: 'settings', label: 'Compte' },
                ].map(item => (
                    <button key={item.id} onClick={() => setView(item.id)} className={`flex flex-col items-center w-1/5 p-2 rounded-xl transition-all ${active === item.id ? 'text-primary bg-primary/10' : 'text-subtext'}`}>
                        <Icon name={item.icon} size={22} />
                        <span className="text-[10px] mt-1 font-medium">{item.label}</span>
                    </button>
                ))}
            </div>
        );

        // 2. MODAL D'AJOUT DE NOTE (Optimis√© Mobile)
        const GradeModal = ({ module, grades, onClose, onSave }) => {
            const [localGrades, setLocalGrades] = useState(grades || []);
            const [val, setVal] = useState('');
            const [coef, setCoef] = useState('1');
            const [name, setName] = useState('');

            const add = () => {
                if(!val) return;
                const next = [...localGrades, { id: Date.now(), value: val, coef: coef, name: name || 'Note' }];
                setLocalGrades(next); onSave(next); setVal(''); setName('');
            };
            const remove = (id) => {
                const next = localGrades.filter(g => g.id !== id);
                setLocalGrades(next); onSave(next);
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-end justify-center glass-modal">
                    <div className="bg-[#121212] w-full max-w-md rounded-t-3xl border-t border-white/10 flex flex-col max-h-[90vh] slide-up">
                        <div className="p-4 flex justify-between items-center border-b border-white/10">
                            <div><h3 className="font-bold text-lg text-white">{module.label}</h3><p className="text-xs text-subtext">{module.id}</p></div>
                            <button onClick={onClose} className="p-2 bg-white/10 rounded-full"><Icon name="x" size={20}/></button>
                        </div>
                        
                        <div className="p-4 overflow-y-auto pb-safe space-y-4">
                            {/* FORMULAIRE EN HAUT */}
                            <div className="bg-primary/10 p-4 rounded-xl border border-primary/20 space-y-3">
                                <label className="text-xs font-bold text-primary uppercase">Nouvelle Note</label>
                                <div className="flex gap-2">
                                    <input value={name} onChange={e=>setName(e.target.value)} placeholder="Titre (ex: DS1)" className="flex-1 bg-black/40 border border-white/10 rounded-lg p-3 text-sm focus:border-primary outline-none" />
                                    <input type="number" value={val} onChange={e=>setVal(e.target.value)} placeholder="20" className="w-16 bg-black/40 border border-white/10 rounded-lg p-3 text-sm font-bold text-center focus:border-primary outline-none" />
                                    <input type="number" value={coef} onChange={e=>setCoef(e.target.value)} placeholder="1" className="w-14 bg-black/40 border border-white/10 rounded-lg p-3 text-sm text-center text-subtext focus:border-primary outline-none" />
                                </div>
                                <button onClick={add} className="w-full bg-primary text-white py-3 rounded-lg font-bold text-sm shadow-lg shadow-primary/20 active:scale-95 transition-transform">AJOUTER</button>
                            </div>

                            <div className="space-y-2">
                                <label className="text-xs font-bold text-subtext uppercase">Historique</label>
                                {localGrades.length === 0 ? <p className="text-center text-sm text-subtext py-4">Aucune note</p> : 
                                localGrades.slice().reverse().map(g => (
                                    <div key={g.id} className="flex justify-between items-center bg-card p-3 rounded-xl border border-white/5">
                                        <div><div className="font-bold text-sm">{g.name}</div><div className="text-xs text-subtext">Coef {g.coef}</div></div>
                                        <div className="flex items-center gap-3">
                                            <span className={`font-mono font-bold text-lg ${getGradeColor(g.value)}`}>{g.value}</span>
                                            <button onClick={()=>remove(g.id)} className="text-danger opacity-50 hover:opacity-100"><Icon name="trash-2" size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. WIDGETS VIE √âTUDIANTE
        const WeatherWidget = () => {
            const [temp, setTemp] = useState('--');
            useEffect(() => {
                fetch('https://api.open-meteo.com/v1/forecast?latitude=45.77&longitude=4.88&current_weather=true') // Villeurbanne Coords
                    .then(res => res.json())
                    .then(data => setTemp(Math.round(data.current_weather.temperature)))
                    .catch(e => console.log(e));
            }, []);
            return (
                <div className="glass p-4 rounded-2xl flex items-center justify-between">
                    <div>
                        <div className="text-xs text-subtext uppercase font-bold">M√©t√©o Villeurbanne</div>
                        <div className="text-2xl font-bold mt-1">{temp}¬∞C</div>
                    </div>
                    <Icon name="cloud-sun" size={32} className="text-yellow-400" />
                </div>
            );
        };

        const CrousMenu = () => (
            <div className="bg-card border border-white/5 p-4 rounded-2xl space-y-3">
                <div className="flex justify-between items-center">
                    <h3 className="font-bold text-white flex gap-2 items-center"><Icon name="utensils" size={16} className="text-primary"/> Crous Gratte-Ciel</h3>
                    <span className="text-[10px] bg-success/20 text-success px-2 py-0.5 rounded">Ouvert</span>
                </div>
                <div className="text-sm text-subtext space-y-1">
                    <p>üå≠ <span className="text-white">Plat du jour :</span> Burger Maison</p>
                    <p>üçù <span className="text-white">P√¢tes :</span> Carbonara</p>
                    <p>ü•ó <span className="text-white">V√©g√© :</span> Curry de l√©gumes</p>
                </div>
            </div>
        );

        const MetroStatus = () => (
            <div className="bg-card border border-white/5 p-4 rounded-2xl">
                <h3 className="font-bold text-white mb-2 flex gap-2"><Icon name="train" size={16} className="text-accent"/> √âtat Trafic TCL</h3>
                <div className="flex gap-2">
                    <div className="flex-1 bg-white/5 p-2 rounded-lg text-center"><div className="font-bold text-success">M. A</div><div className="text-[10px] text-subtext">Normal</div></div>
                    <div className="flex-1 bg-white/5 p-2 rounded-lg text-center"><div className="font-bold text-warning">T. 1</div><div className="text-[10px] text-subtext">Perturb√©</div></div>
                    <div className="flex-1 bg-white/5 p-2 rounded-lg text-center"><div className="font-bold text-success">C. 3</div><div className="text-[10px] text-subtext">Normal</div></div>
                </div>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('HOME');
            const [user, setUser] = useState(null);
            
            // Data States
            const [s1Grades, setS1Grades] = useState({ ue11: '', ue12: '' });
            const [s2Grades, setS2Grades] = useState({});
            const [adeUrl, setAdeUrl] = useState(DEFAULT_ADE);
            const [events, setEvents] = useState([]);
            const [nextDS, setNextDS] = useState(null);
            const [selectedModule, setSelectedModule] = useState(null);
            
            // Calculs
            const [stats, setStats] = useState({ ue21: null, ue22: null, s2: null });

            // Init
            useEffect(() => {
                const init = async () => {
                    // Simulation auth pour demo si pas de firebase config
                    if(typeof __firebase_config === 'undefined') {
                        const localData = JSON.parse(localStorage.getItem('geii_data') || '{}');
                        setS1Grades(localData.s1 || { ue11: '', ue12: '' });
                        setS2Grades(localData.s2 || {});
                        setAdeUrl(localData.ade || DEFAULT_ADE);
                        setUser({ uid: 'demo' });
                        return;
                    }
                    // Real Firebase Init would go here (skipped for brevity, using demo logic if needed)
                };
                init();
            }, []);

            // Sauvegarde Local (Fallback)
            useEffect(() => {
                if(user) {
                    localStorage.setItem('geii_data', JSON.stringify({ s1: s1Grades, s2: s2Grades, ade: adeUrl }));
                }
            }, [s1Grades, s2Grades, adeUrl, user]);

            // Fetch Agenda & Detect DS
            useEffect(() => {
                const fetchEdt = async () => {
                    try {
                        const proxy = 'https://corsproxy.io/?' + encodeURIComponent(adeUrl);
                        const res = await fetch(proxy);
                        const text = await res.text();
                        const parsed = parseICS(text);
                        
                        // Filter Future Events
                        const now = new Date();
                        const upcoming = parsed.filter(e => e.start > now).sort((a,b) => a.start - b.start);
                        setEvents(upcoming);

                        // Find next DS
                        const ds = upcoming.find(e => 
                            e.summary.toLowerCase().includes('ds') || 
                            e.summary.toLowerCase().includes('exam') || 
                            e.summary.toLowerCase().includes('contr√¥le')
                        );
                        setNextDS(ds);

                    } catch(e) { console.log("Erreur EDT", e); }
                };
                if(adeUrl) fetchEdt();
            }, [adeUrl]);

            // Calcul Moyennes S2
            useEffect(() => {
                let pts21=0, c21=0, pts22=0, c22=0;
                MODULES_CONFIG_S2.forEach(m => {
                    const avg = parseFloat(calcAvg(s2Grades[m.id]));
                    if(!isNaN(avg)) {
                        if(m.coef21 > 0) { pts21 += avg * m.coef21; c21 += m.coef21; }
                        if(m.coef22 > 0) { pts22 += avg * m.coef22; c22 += m.coef22; }
                    }
                });
                const avg21 = c21 ? (pts21/c21).toFixed(2) : null;
                const avg22 = c22 ? (pts22/c22).toFixed(2) : null;
                const s2 = (avg21 && avg22) ? ((parseFloat(avg21)+parseFloat(avg22))/2).toFixed(2) : null;
                setStats({ ue21: avg21, ue22: avg22, s2 });
            }, [s2Grades]);

            // Validation Ann√©e
            const validateYear = () => {
                const s1 = (parseFloat(s1Grades.ue11) + parseFloat(s1Grades.ue12)) / 2;
                const s2 = parseFloat(stats.s2);
                if(!s1 || !s2) return { status: 'PENDING', label: 'En attente' };
                
                const global = (s1 + s2) / 2;
                // R√®gle simplifi√©e : > 10 partout = OK, sinon danger
                if(s1 >= 10 && s2 >= 10) return { status: 'OK', label: 'PASSAGE VALID√â ‚úÖ', color: 'text-success' };
                if(global >= 10) return { status: 'WARN', label: 'COMPENSATION ? ‚ö†Ô∏è', color: 'text-warning' };
                return { status: 'FAIL', label: 'EN DANGER üõë', color: 'text-danger' };
            };

            const status = validateYear();

            if (!user) return <div className="h-screen bg-black flex items-center justify-center text-white">Chargement GEII OS...</div>;

            return (
                <div className="min-h-screen bg-bg text-white pb-24 font-sans">
                    
                    {/* MODAL */}
                    {selectedModule && <GradeModal module={selectedModule} grades={s2Grades[selectedModule.id]} onClose={()=>setSelectedModule(null)} onSave={(g)=>setS2Grades({...s2Grades, [selectedModule.id]: g})} />}

                    {/* HEADER */}
                    <div className="p-6 pt-12 flex justify-between items-end bg-gradient-to-b from-primary/20 to-transparent">
                        <div>
                            <div className="text-xs font-bold text-primary mb-1 uppercase tracking-wider">Mon Espace</div>
                            <h1 className="text-3xl font-bold">Bonjour üëã</h1>
                        </div>
                        <div className="w-10 h-10 rounded-full bg-card border border-white/10 flex items-center justify-center font-bold text-sm">You</div>
                    </div>

                    {/* CONTENU */}
                    <div className="px-4 space-y-6">

                        {/* HOME VIEW */}
                        {view === 'HOME' && (
                            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                
                                {/* ALERTE DS */}
                                {nextDS && (
                                    <div className="bg-gradient-to-r from-danger/20 to-orange-500/20 p-4 rounded-2xl border border-danger/30 flex items-center gap-4">
                                        <div className="bg-danger/20 p-3 rounded-full text-danger"><Icon name="alert-triangle" size={24}/></div>
                                        <div>
                                            <div className="text-xs font-bold text-danger uppercase">Prochain DS D√©tect√©</div>
                                            <div className="font-bold text-white">{nextDS.summary}</div>
                                            <div className="text-xs text-subtext">{new Date(nextDS.start).toLocaleDateString('fr-FR', {weekday: 'long', day: 'numeric'})} ‚Ä¢ {nextDS.location}</div>
                                        </div>
                                    </div>
                                )}

                                {/* STATUS PASSAGE */}
                                <div className="glass p-5 rounded-3xl relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="flag" size={80}/></div>
                                    <h2 className="text-sm font-bold text-subtext uppercase tracking-wider mb-2">Statut Ann√©e</h2>
                                    <div className={`text-2xl font-bold ${status.color} mb-1`}>{status.label}</div>
                                    <div className="text-xs text-subtext">Moyenne S2 Est. : <span className="text-white font-mono">{stats.s2 || '--'}</span></div>
                                </div>

                                <WeatherWidget />
                                
                                {/* PROCHAINS COURS */}
                                <div>
                                    <h3 className="font-bold mb-3 flex items-center gap-2">Prochains cours <Icon name="chevron-right" size={16} className="text-subtext"/></h3>
                                    <div className="space-y-2">
                                        {events.slice(0, 3).map((e, i) => (
                                            <div key={i} className="bg-card p-3 rounded-xl border border-white/5 flex gap-3 items-center">
                                                <div className="flex flex-col items-center min-w-[40px]">
                                                    <span className="text-xs font-bold text-white">{e.start.getHours()}h{e.start.getMinutes()||'00'}</span>
                                                </div>
                                                <div className="h-8 w-[2px] bg-primary rounded-full"></div>
                                                <div className="overflow-hidden">
                                                    <div className="font-bold text-sm truncate">{e.summary}</div>
                                                    <div className="text-[10px] text-subtext">{e.location}</div>
                                                </div>
                                            </div>
                                        ))}
                                        {events.length === 0 && <div className="text-center text-xs text-subtext py-4">Aucun cours √† venir</div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* NOTES VIEW */}
                        {view === 'NOTES' && (
                            <div className="space-y-6 animate-in fade-in duration-300">
                                
                                {/* S1 INPUTS */}
                                <div className="bg-card p-4 rounded-2xl border border-white/5 space-y-3">
                                    <h3 className="font-bold text-sm uppercase text-subtext flex gap-2 items-center"><Icon name="archive" size={14}/> Moyennes S1 (Acquis)</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] text-subtext block mb-1">Moy. UE11</label>
                                            <input type="number" value={s1Grades.ue11} onChange={e=>setS1Grades({...s1Grades, ue11: e.target.value})} className="w-full bg-black/50 border border-white/10 rounded-lg p-2 text-center font-mono font-bold" placeholder="--" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] text-subtext block mb-1">Moy. UE12</label>
                                            <input type="number" value={s1Grades.ue12} onChange={e=>setS1Grades({...s1Grades, ue12: e.target.value})} className="w-full bg-black/50 border border-white/10 rounded-lg p-2 text-center font-mono font-bold" placeholder="--" />
                                        </div>
                                    </div>
                                </div>

                                {/* S2 LIST */}
                                <div>
                                    <div className="flex justify-between items-end mb-4 px-1">
                                        <h2 className="text-xl font-bold">Semestre 2</h2>
                                        <span className="text-xs bg-primary/20 text-primary px-2 py-1 rounded">En cours</span>
                                    </div>
                                    
                                    {/* UE 21 */}
                                    <div className="mb-6">
                                        <div className="flex justify-between items-center bg-blue-900/20 p-2 rounded-lg mb-2 border border-blue-500/20">
                                            <span className="text-xs font-bold text-blue-400 uppercase ml-2">UE21 - Concevoir</span>
                                            <span className="font-mono font-bold text-white mr-2">{stats.ue21 || '--'}</span>
                                        </div>
                                        <div className="space-y-2">
                                            {MODULES_CONFIG_S2.filter(m => m.coef21 > 0).map(m => (
                                                <div key={m.id} onClick={()=>setSelectedModule(m)} className="bg-card p-3 rounded-xl flex justify-between items-center active:scale-95 transition-transform border border-white/5">
                                                    <div>
                                                        <div className="font-bold text-sm">{m.label}</div>
                                                        <div className="text-[10px] text-subtext">{m.short} ‚Ä¢ Coef {m.coef21}</div>
                                                    </div>
                                                    <div className={`font-mono font-bold ${getGradeColor(calcAvg(s2Grades[m.id]))}`}>{calcAvg(s2Grades[m.id]) || "‚Äî"}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* UE 22 */}
                                    <div>
                                        <div className="flex justify-between items-center bg-purple-900/20 p-2 rounded-lg mb-2 border border-purple-500/20">
                                            <span className="text-xs font-bold text-purple-400 uppercase ml-2">UE22 - V√©rifier</span>
                                            <span className="font-mono font-bold text-white mr-2">{stats.ue22 || '--'}</span>
                                        </div>
                                        <div className="space-y-2">
                                            {MODULES_CONFIG_S2.filter(m => m.coef22 > 0).map(m => (
                                                <div key={m.id} onClick={()=>setSelectedModule(m)} className="bg-card p-3 rounded-xl flex justify-between items-center active:scale-95 transition-transform border border-white/5">
                                                    <div>
                                                        <div className="font-bold text-sm">{m.label}</div>
                                                        <div className="text-[10px] text-subtext">{m.short} ‚Ä¢ Coef {m.coef22}</div>
                                                    </div>
                                                    <div className={`font-mono font-bold ${getGradeColor(calcAvg(s2Grades[m.id]))}`}>{calcAvg(s2Grades[m.id]) || "‚Äî"}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* AGENDA VIEW */}
                        {view === 'AGENDA' && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <h2 className="text-2xl font-bold mb-4">Agenda</h2>
                                {events.length === 0 ? <p className="text-center text-subtext text-sm mt-10">Aucun √©v√©nement trouv√© ou lien ADE non configur√©.</p> : 
                                    events.slice(0, 20).map((e, i) => {
                                        const dateStr = e.start.toLocaleDateString('fr-FR', {weekday: 'long', day: 'numeric', month: 'short'});
                                        const prevDate = i > 0 ? events[i-1].start.toLocaleDateString('fr-FR', {weekday: 'long', day: 'numeric', month: 'short'}) : '';
                                        const isNewDay = dateStr !== prevDate;
                                        
                                        return (
                                            <div key={i}>
                                                {isNewDay && <div className="sticky top-0 bg-bg/95 backdrop-blur py-2 text-xs font-bold text-primary uppercase tracking-wider z-10">{dateStr}</div>}
                                                <div className="bg-card p-3 rounded-xl border border-white/5 mb-2 flex gap-3">
                                                    <div className="flex flex-col items-center justify-center min-w-[50px] border-r border-white/10 pr-3">
                                                        <span className="font-bold text-sm">{e.start.getHours()}h{e.start.getMinutes()||'00'}</span>
                                                        <span className="text-[10px] text-subtext">{e.end.getHours()}h{e.end.getMinutes()||'00'}</span>
                                                    </div>
                                                    <div className="overflow-hidden">
                                                        <div className="font-bold text-sm truncate">{e.summary}</div>
                                                        <div className="text-xs text-subtext truncate flex gap-1 items-center"><Icon name="map-pin" size={10}/> {e.location}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                }
                            </div>
                        )}

                        {/* LIFE VIEW */}
                        {view === 'LIFE' && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <h2 className="text-2xl font-bold mb-4">Vie √âtudiante</h2>
                                <CrousMenu />
                                <MetroStatus />
                                
                                {/* BDE / URGENCE CARD */}
                                <div className="bg-gradient-to-br from-indigo-900/40 to-purple-900/40 border border-white/10 p-4 rounded-2xl">
                                    <h3 className="font-bold text-white mb-3 flex items-center gap-2"><Icon name="heart-pulse" size={18} className="text-pink-500"/> Urgences & BDE</h3>
                                    <div className="space-y-2 text-sm">
                                        <div className="flex justify-between items-center bg-black/20 p-2 rounded-lg">
                                            <span>üè• Infirmerie IUT</span>
                                            <a href="tel:0472448000" className="text-primary font-bold">Appeler</a>
                                        </div>
                                        <div className="flex justify-between items-center bg-black/20 p-2 rounded-lg">
                                            <span>üéâ Soir√©e Int√©gration</span>
                                            <span className="text-subtext text-xs">12 Mars</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* SETTINGS VIEW */}
                        {view === 'SETTINGS' && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <h2 className="text-2xl font-bold mb-4">Compte</h2>
                                
                                <div className="bg-card p-4 rounded-2xl border border-white/5 space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-subtext uppercase block mb-2">Lien ADE (ICS)</label>
                                        <input type="text" value={adeUrl} onChange={e=>setAdeUrl(e.target.value)} className="w-full bg-black/50 border border-white/10 rounded-lg p-3 text-xs text-subtext break-all" />
                                        <p className="text-[10px] text-subtext mt-1">Copiez le lien "Export iCal" depuis l'ENT Lyon 1.</p>
                                    </div>
                                </div>

                                <div className="bg-card p-4 rounded-2xl border border-white/5">
                                    <h3 className="font-bold text-sm mb-3">Mes Donn√©es</h3>
                                    <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="w-full bg-danger/10 text-danger border border-danger/20 py-3 rounded-xl font-bold text-sm">R√©initialiser l'application</button>
                                </div>
                            </div>
                        )}

                    </div>

                    <BottomNav active={view} setView={setView} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
